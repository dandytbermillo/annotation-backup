# Canvas State Persistence – Status (2025‑10‑14)

## Work Performed (Latest)
- Introduced workspace versioning to unblock the ghost-panel remedy Phase 1:
  - Added `migrations/036_add_canvas_workspace_version.{up,down}.sql`, creating a monotonic `version` column on `canvas_workspace_notes` with a trigger to prevent regressions.
  - Extended the workspace API (`app/api/canvas/workspace/route.ts`) so open/close mutations bump the version, return the new value, and reject stale callers that send an `expectedVersion`.
  - Client workspace context now tracks versions, clears localStorage/IndexedDB snapshots on close, and applies server-supplied version bumps (`components/canvas/canvas-workspace-context.tsx`).
  - Snapshot persistence/tagging flows pass the version through load/save, preventing stale caches from hydrating (`components/annotation-canvas-modern.tsx`, `lib/canvas/canvas-storage.ts`, `lib/hooks/use-canvas-hydration.ts`).
  - Added integration coverage to ensure closing/reopening increments the version and marks the main panel closed (`__tests__/integration/workspace-snapshot.test.ts`).
- Phase 2 progress:
  - Persist workspace version maps to `localStorage` so background processes (offline queue, hydrators) can validate against the latest counters between sessions (`components/canvas/canvas-workspace-context.tsx`).
  - Reduced snapshot TTL from 7 days to 24 hours, keeping cached layouts fresh while still providing fast reloads (`lib/hooks/use-canvas-hydration.ts`, `lib/canvas/canvas-storage.ts`).
  - Offline queue entries now carry the originating workspace version; replays abort (with telemetry) if the live version has advanced, preventing stale panel/camera writes from resurrecting ghost panels (`lib/hooks/use-panel-persistence.ts`, `lib/hooks/use-camera-persistence.ts`, `lib/canvas/canvas-offline-queue.ts`).
- Normalized branch panel IDs everywhere they enter the Option‑A pipeline so connection rendering always finds matching parent/child panels:
  - Workspace hydrator now rewrites panel/parent IDs to the `branch-<uuid>` form before seeding the shared `dataStore`, and migrates any legacy keys (`components/canvas/canvas-workspace-context.tsx`).
  - Plain‑mode localStorage replay now normalizes panel IDs, branch arrays, and parent metadata, replacing raw UUID keys and deleting old entries (`components/canvas/canvas-context.tsx`).
  - Server hydration applies the same normalization prior to merging panels into `dataStore`, `branchesMap`, and `LayerManager`, while upgrading legacy keys in place (`lib/hooks/use-canvas-hydration.ts`).
- Audited the “ghost panel” scenario and captured the root cause plus long-term fix plan in `docs/proposal/canvas_state_persistence/fixes/ghost_panel/fix-report.md`; confirmed the panel-reappearance bug is still unresolved pending state filtering/workspace lifecycle changes.
- Logged before/after queries against `debug_logs` to confirm `branch_not_found` entries disappear once normalized keys flow through.
- Captured the resolution in `docs/proposal/canvas_state_persistence/fixes/connection_lines_issue_when_app_is_reload/FIX_REPORT.md`.
- Centered new-note spawning by removing the `{x:2000,y:1500}` fallback:
  - Canvas provider now boots with a neutral `{translateX:0, translateY:0}` camera and seeds the main panel at the viewport centre (`components/canvas/canvas-context.tsx`).
  - Workspace fallback uses the same centred helper when no stored position exists, so the first note appears in view even with an empty cache (`components/canvas/canvas-workspace-context.tsx`).
  - Documentation updated with the new plan for extending the behaviour to existing notes and adding a “Restore position” affordance.

## Observations
- Phase 2 is complete: snapshots use the trimmed `{version,savedAt,panels}` payload, TTL is 24 h, workspace versions persist to localStorage, and queued replays respect the version handshake (`phase2-evaluation.md` documents cold-load metrics and the decision to keep snapshots/offline queue).
- Phase 3 telemetry is partially live: cache hits/misses/discards emit `canvas.cache_used`, `canvas.cache_mismatch`, and `canvas.cache_discarded`, and stale snapshots auto-delete without prompting the user; reconciliation work can now focus on surfacing those signals.
- Added unit coverage around the snapshot loader so version mismatches and TTL expiry are asserted (`__tests__/unit/canvas-storage.test.ts`).
- After normalization, reloads consistently draw connection lines; the earlier “every other reload” failure no longer reproduces.
- TypeScript checks are green again; continue watching for regressions as more reconciliation code lands.
- Existing logs show legacy rows in `panels` still contain raw UUID IDs; the UI now overwrites them in-memory, but a DB cleanup/migration would keep persistence consistent.
- Ghost panel issue remains open: lingering panel rows (`state='active'`) plus workspace/localStorage rehydration continue to re-insert closed panels. No state filtering or lifecycle persistence has been shipped yet, so “ghost” panels will keep returning until the fix plan in `ghost_panel/fix-report.md` is implemented.
- Manual QA confirmed cache telemetry (hits, mismatches, expiry), TTL enforcement, and offline queue replay; the only untested telemetry path is `workspace_version_mismatch`, which needs a deliberate multi-client conflict.
- Verified the first note now spawns centred on an empty workspace without the post-hydration snap; existing notes still honour persisted positions until the “center existing notes + restore control” work lands.

## Next Steps
1. Apply the new migration in lower environments (`npm run db:migrate`) and backfill any existing `canvas_workspace_notes` rows if needed.
2. Finish Phase 3 by wiring the cache/queue telemetry into dashboards or smoke tests (include `canvas.cache_*` and a staged `workspace_version_mismatch` run) and capture the updated reconciliation flow in docs.
3. Explicitly exercise a multi-user version conflict so we can observe `workspace_version_mismatch` in the wild (or build a deterministic test).
4. Optionally backfill the `panels` table to normalize stored IDs once the workspace reconciliation is in place, then prune the extra debug logging added during earlier investigations.
5. Implement the “center existing notes, hide branch panels, add Restore Position control” plan (`docs/proposal/canvas_state_persistence/plan/make_existing_notes_visually_centred/implementation_plan.md`); confirm the restore affordance animates to the persisted coordinates.

## Current Status
- Local branch contains normalization fixes; verified manually and via `debug_logs` queries.
- Connection lines persist across reloads without user interaction.
- Ghost-panel bug is documented but still unresolved; Phase 1 versioning is complete, and Phase 2/3 remain outstanding per `plan/worksspace_architecture/ghost_panel_remedy.md`.
- Outstanding TODOs: apply the migration, drive Phase 3 reconciliation, clean up the `panels` table (optional), and fix existing TypeScript warnings in `canvas-panel.tsx`.

### 2025-10-14 Investigation — Toolbar Reopen Recentering
- Verified the hydration-gap sequence where the canvas renders a persisted panel before `openNotes` hydrates; the toolbar click then treats the note as unopened, `resolveMainPanelPosition` returns `null`, `hasPersistedPosition` stays `false`, and the centering override seeds `freshNoteSeeds[noteId]`, forcing the panel to jump (`components/annotation-app.tsx:1401-1561`, `components/annotation-canvas-modern.tsx:704-708`).
- Confirmed console evidence showing `isToolbarCreation: true` originated from the “New Note” path (`components/annotation-app.tsx:2608`); existing toolbar entries call `onActivateNote(noteId)` without options (`components/canvas/workspace-toolbar.tsx:81`), so the recentering regression is confined to already-visible notes during hydration.
- Determined the highlight animation’s `scale(1.01)` transform (`components/canvas/canvas-panel.tsx:3182`) only produces a local pop; it does not drive the workspace-centering bug, though it can introduce a small viewport jitter when a note is near the edge.

#### Current Issue Detail
- Repro: Hard refresh with an open note → panel renders in place → click the corresponding toolbar entry before workspace hydration completes → panel recenters and overrides the actual persisted coordinates.
- Key state at failure: `alreadyOpen=false`, `persistedPosition=null`, `shouldCenterExisting=true`, `freshNoteSeeds[noteId]=centeredCandidate`. Impact: visible panels jitter to the viewport centre despite valid stored positions, breaking spatial memory.
- Secondary observation: the highlight `scale(1.01)` effect can nudge the viewport when panels sit near scrollbar thresholds, causing a subtle canvas wiggle even when centering is skipped.

#### Actions Taken Today
1. Tested the highlight-styling change (removing the `scale(1.01)` transform) to check whether the viewport wiggle disappeared; reverted to the original styling after confirming the jitter persisted and the glow looked flat (`components/canvas/canvas-panel.tsx:3182`).
2. Captured the hydration-gap root cause and highlight experiment details here for continuity.

#### Planned Follow-up
1. Implement a guard that treats visible panels from the shared `dataStore` as having a persisted position (Option A) so `shouldCenterExisting` short-circuits during hydration.
2. Add targeted debug logging around the guard hit/miss to validate the fix during the repro flow.
3. Re-test the hydrate → toolbar click scenario to ensure the panel stays put, then update the implementation plan and proposal docs with outcomes and any follow-up work.
