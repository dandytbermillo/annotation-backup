# Canvas State Persistence – Status (2025‑10‑14)

## Work Performed
- Instrumented the plain-mode branch loader to log raw `parentId` values returning from `listBranches`, confirming the DB still reports `main` for existing child panels (`components/canvas/canvas-context.tsx`).
- Reworked `WidgetStudioConnections` to recompute whenever the plain `dataStore` mutates, deduplicate parent-child edges, and surface debug traces; added guard-rail logging to highlight missing relationships (`components/canvas/widget-studio-connections.tsx`).
- Updated the hydration flow to merge panel data into the existing store entry instead of overwriting it, preserving fields like `parentId` before the connection pass runs (`lib/hooks/use-canvas-hydration.ts`).
- Propagated the connection component’s key off `canvasContextState.lastUpdate` to ensure the branch loader’s `BRANCH_UPDATED` dispatch triggers a fresh mount (`components/annotation-canvas-modern.tsx`).
- (Reverted) Attempted to emit both screen- and world-space coordinates directly from hydration and consume them in `PanelsRenderer`; this pushed panels off-screen after reload, so those changes were backed out.
- Logged the change in live context for traceability.
- Began implementing the "main-only on note open" flow: initial app hydration still restores the full workspace, while subsequent note opens now add only the main panel to `canvasItems` (`components/annotation-canvas-modern.tsx`).

## Observations & Clarifications
- Hydration now merges branch metadata without wiping `parentId`, so connections reappear immediately for previously opened notes.
- Attempted world/screen coordinate adjustments pushed panels off-screen and were reverted; current behavior falls back to the pre-existing layout logic.
- **Desired outcome (TBD):**
  - On app load, each note’s canvas should restore whatever main/branch panels the user left open (current behavior).
  - When the user opens a different note—whether brand new or existing—it should initially show only the main panel centered, with branch panels closed until explicitly opened.

## Next Steps
1. Reload in plain mode and confirm connections stay stable (`count > 0`).
2. Outline changes needed to honor the clarified UX: open notes should restore their prior layout, but newly opened notes should show only the main panel centered.
3. Prototype the main-panel-only open flow in a branch (ensure branch data remains in the store for manual reopen).
4. Once a stable approach is identified, remove or downgrade the temporary debug logging.

## Current Status
- Code changes staged locally (no tests run yet due to ongoing debugging). Latest hydration/render experiment was reverted after pushing panels off-screen.
- Plain-mode hydration now preserves parent relationships in-memory; existing notes show connections immediately. New-note behavior still matches the previous restore-all layout until we implement the clarified UX.
- Awaiting design/implementation of the “main-only on open” flow before further cleanup or regression checks.
