# Canvas State Persistence – Status (2025‑10‑14)

## Work Performed (Latest)
- Normalized branch panel IDs everywhere they enter the Option‑A pipeline so connection rendering always finds matching parent/child panels:
  - Workspace hydrator now rewrites panel/parent IDs to the `branch-<uuid>` form before seeding the shared `dataStore`, and migrates any legacy keys (`components/canvas/canvas-workspace-context.tsx`).
  - Plain‑mode localStorage replay now normalizes panel IDs, branch arrays, and parent metadata, replacing raw UUID keys and deleting old entries (`components/canvas/canvas-context.tsx`).
  - Server hydration applies the same normalization prior to merging panels into `dataStore`, `branchesMap`, and `LayerManager`, while upgrading legacy keys in place (`lib/hooks/use-canvas-hydration.ts`).
- Audited the “ghost panel” scenario and captured the root cause plus long-term fix plan in `docs/proposal/canvas_state_persistence/fixes/ghost_panel/fix-report.md`; confirmed the panel-reappearance bug is still unresolved pending state filtering/workspace lifecycle changes.
- Logged before/after queries against `debug_logs` to confirm `branch_not_found` entries disappear once normalized keys flow through.
- Captured the resolution in `docs/proposal/canvas_state_persistence/fixes/connection_lines_issue_when_app_is_reload/FIX_REPORT.md`.

## Observations
- After normalization, reloads consistently draw connection lines; the earlier “every other reload” failure no longer reproduces.
- TypeScript still flags unrelated issues in `components/canvas/canvas-panel.tsx` (pre-existing errors about `DataStore.keys`), so `npm run type-check` remains red.
- Existing logs show legacy rows in `panels` still contain raw UUID IDs; the UI now overwrites them in-memory, but a DB cleanup/migration would keep persistence consistent.
- Ghost panel issue remains open: lingering panel rows (`state='active'`) plus workspace/localStorage rehydration continue to re-insert closed panels. No state filtering or lifecycle persistence has been shipped yet, so “ghost” panels will keep returning until the fix plan in `ghost_panel/fix-report.md` is implemented.

## Next Steps
1. Decide whether to backfill the `panels` table so stored IDs match the runtime normalization (SQL migration / script).
2. Address the outstanding `canvas-panel.tsx` type errors so `npm run type-check` passes again.
3. Ship the ghost-panel lifecycle fix:
   - Persist panel close state (`state='closed'`) instead of deleting rows.
   - Filter closed panels from workspace/API hydration paths.
   - Update workspace persistence so manually closed panels aren’t re-marked as open.
4. Re-run targeted manual verification: reload in plain mode, confirm `WidgetStudioConnections` no longer logs `branch_not_found`, spot-check workspace hydrator output, and validate the ghost panel stays hidden after close/reload.
5. Once the DB is updated (if desired), prune the extra debug logging that was added for diagnosis.

## Current Status
- Local branch contains normalization fixes; verified manually and via `debug_logs` queries.
- Connection lines persist across reloads without user interaction.
- Ghost-panel bug is documented but still unresolved; awaiting the lifecycle/state filtering work outlined above.
- Outstanding TODOs: DB cleanup (optional), fix existing TypeScript warnings in `canvas-panel.tsx`, implement ghost-panel lifecycle fix, and follow through on the “main-only on open” UX work once current cleanup is complete.
