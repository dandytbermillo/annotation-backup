# Canvas State Persistence – Status (2025‑10‑14)

## Work Performed
- Instrumented the plain-mode branch loader to log raw `parentId` values returning from `listBranches`, confirming the DB still reports `main` for existing child panels (`components/canvas/canvas-context.tsx`).
- Reworked `WidgetStudioConnections` to recompute whenever the plain `dataStore` mutates, deduplicate parent-child edges, and surface debug traces; added guard-rail logging to highlight missing relationships (`components/canvas/widget-studio-connections.tsx`).
- Updated the hydration flow to merge panel data into the existing store entry instead of overwriting it, preserving fields like `parentId` before the connection pass runs (`lib/hooks/use-canvas-hydration.ts`).
- Propagated the connection component’s key off `canvasContextState.lastUpdate` to ensure the branch loader’s `BRANCH_UPDATED` dispatch triggers a fresh mount (`components/annotation-canvas-modern.tsx`).
- Logged the change in live context for traceability.

## Observations
- Before the merge fix, hydration overwrote each branch record with world-position data, clearing `parentId` and leaving connections empty even though the loader supplied the correct parent information.
- The debug console now clearly distinguishes the loader stage (parent IDs intact) from the connection stage (previously missing parent IDs), helping isolate issues quickly.
- Pending verification: confirm that the merged hydration data still carries `parentId` through to the SVG computation; connection counts should become non-zero right after reload.

## Next Steps
1. Reload the app in plain mode and inspect dev tools: expect `[WidgetStudioConnections] recomputed connections` to report a non-zero `count`, with no “branch missing parentId” entries.
2. If counts remain zero, capture a panel snapshot (`window.canvasDataStore.get(<branchId>)`) to confirm the merge is working; adjust creation/update paths if any still overwrite `parentId`.
3. Once verified, remove or downgrade the debug logging before shipping to keep console noise low.

## Current Status
- Code changes staged locally (no tests run yet due to ongoing debugging).
- Plain-mode hydration now preserves parent relationships in-memory; connections should appear after verification.
- Awaiting manual reload validation before proceeding to cleanup or wider regression checks.
