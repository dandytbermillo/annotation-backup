# Canvas State Persistence – Status (2025‑10‑14)

## Work Performed (Latest)
- Introduced workspace versioning to unblock the ghost-panel remedy Phase 1:
  - Added `migrations/036_add_canvas_workspace_version.{up,down}.sql`, creating a monotonic `version` column on `canvas_workspace_notes` with a trigger to prevent regressions.
  - Extended the workspace API (`app/api/canvas/workspace/route.ts`) so open/close mutations bump the version, return the new value, and reject stale callers that send an `expectedVersion`.
  - Client workspace context now tracks versions, clears localStorage/IndexedDB snapshots on close, and applies server-supplied version bumps (`components/canvas/canvas-workspace-context.tsx`).
  - Snapshot persistence/tagging flows pass the version through load/save, preventing stale caches from hydrating (`components/annotation-canvas-modern.tsx`, `lib/canvas/canvas-storage.ts`, `lib/hooks/use-canvas-hydration.ts`).
  - Added integration coverage to ensure closing/reopening increments the version and marks the main panel closed (`__tests__/integration/workspace-snapshot.test.ts`).
- Phase 2 progress:
  - Persist workspace version maps to `localStorage` so background processes (offline queue, hydrators) can validate against the latest counters between sessions (`components/canvas/canvas-workspace-context.tsx`).
  - Reduced snapshot TTL from 7 days to 24 hours, keeping cached layouts fresh while still providing fast reloads (`lib/hooks/use-canvas-hydration.ts`, `lib/canvas/canvas-storage.ts`).
  - Offline queue entries now carry the originating workspace version; replays abort (with telemetry) if the live version has advanced, preventing stale panel/camera writes from resurrecting ghost panels (`lib/hooks/use-panel-persistence.ts`, `lib/hooks/use-camera-persistence.ts`, `lib/canvas/canvas-offline-queue.ts`).
- Normalized branch panel IDs everywhere they enter the Option‑A pipeline so connection rendering always finds matching parent/child panels:
  - Workspace hydrator now rewrites panel/parent IDs to the `branch-<uuid>` form before seeding the shared `dataStore`, and migrates any legacy keys (`components/canvas/canvas-workspace-context.tsx`).
  - Plain‑mode localStorage replay now normalizes panel IDs, branch arrays, and parent metadata, replacing raw UUID keys and deleting old entries (`components/canvas/canvas-context.tsx`).
  - Server hydration applies the same normalization prior to merging panels into `dataStore`, `branchesMap`, and `LayerManager`, while upgrading legacy keys in place (`lib/hooks/use-canvas-hydration.ts`).
- Audited the “ghost panel” scenario and captured the root cause plus long-term fix plan in `docs/proposal/canvas_state_persistence/fixes/ghost_panel/fix-report.md`; confirmed the panel-reappearance bug is still unresolved pending state filtering/workspace lifecycle changes.
- Logged before/after queries against `debug_logs` to confirm `branch_not_found` entries disappear once normalized keys flow through.
- Captured the resolution in `docs/proposal/canvas_state_persistence/fixes/connection_lines_issue_when_app_is_reload/FIX_REPORT.md`.

## Observations
- Phase 2 is complete: snapshots use the trimmed `{version,savedAt,panels}` payload, TTL is 24 h, workspace versions persist to localStorage, and queued replays respect the version handshake (`phase2-evaluation.md` documents cold-load metrics and the decision to keep snapshots/offline queue).
- Phase 3 telemetry is partially live: cache hits/misses/discards emit `canvas.cache_used`, `canvas.cache_mismatch`, and `canvas.cache_discarded`, and stale snapshots auto-delete without prompting the user; reconciliation work can now focus on surfacing those signals.
- Added unit coverage around the snapshot loader so version mismatches and TTL expiry are asserted (`__tests__/unit/canvas-storage.test.ts`).
- After normalization, reloads consistently draw connection lines; the earlier “every other reload” failure no longer reproduces.
- TypeScript checks are green again; continue watching for regressions as more reconciliation code lands.
- Existing logs show legacy rows in `panels` still contain raw UUID IDs; the UI now overwrites them in-memory, but a DB cleanup/migration would keep persistence consistent.
- Ghost panel issue remains open: lingering panel rows (`state='active'`) plus workspace/localStorage rehydration continue to re-insert closed panels. No state filtering or lifecycle persistence has been shipped yet, so “ghost” panels will keep returning until the fix plan in `ghost_panel/fix-report.md` is implemented.
- Manual QA confirmed cache telemetry (hits, mismatches, expiry), TTL enforcement, and offline queue replay; the only untested telemetry path is `workspace_version_mismatch`, which needs a deliberate multi-client conflict.

## Next Steps
1. Apply the new migration in lower environments (`npm run db:migrate`) and backfill any existing `canvas_workspace_notes` rows if needed.
2. Finish Phase 3 by wiring the cache/queue telemetry into dashboards or smoke tests (include `canvas.cache_*` and a staged `workspace_version_mismatch` run) and capture the updated reconciliation flow in docs.
3. Explicitly exercise a multi-user version conflict so we can observe `workspace_version_mismatch` in the wild (or build a deterministic test).
4. Optionally backfill the `panels` table to normalize stored IDs once the workspace reconciliation is in place, then prune the extra debug logging added during earlier investigations.

## Current Status
- Local branch contains normalization fixes; verified manually and via `debug_logs` queries.
- Connection lines persist across reloads without user interaction.
- Ghost-panel bug is documented but still unresolved; Phase 1 versioning is complete, and Phase 2/3 remain outstanding per `plan/worksspace_architecture/ghost_panel_remedy.md`.
- Outstanding TODOs: apply the migration, drive Phase 3 reconciliation, clean up the `panels` table (optional), and fix existing TypeScript warnings in `canvas-panel.tsx`.
