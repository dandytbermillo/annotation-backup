# Canvas State Persistence – Status (2025‑10‑14)

## Work Performed (Latest)
- Introduced workspace versioning to unblock the ghost-panel remedy Phase 1:
  - Added `migrations/036_add_canvas_workspace_version.{up,down}.sql`, creating a monotonic `version` column on `canvas_workspace_notes` with a trigger to prevent regressions.
  - Extended the workspace API (`app/api/canvas/workspace/route.ts`) so open/close mutations bump the version, return the new value, and reject stale callers that send an `expectedVersion`.
- Normalized branch panel IDs everywhere they enter the Option‑A pipeline so connection rendering always finds matching parent/child panels:
  - Workspace hydrator now rewrites panel/parent IDs to the `branch-<uuid>` form before seeding the shared `dataStore`, and migrates any legacy keys (`components/canvas/canvas-workspace-context.tsx`).
  - Plain‑mode localStorage replay now normalizes panel IDs, branch arrays, and parent metadata, replacing raw UUID keys and deleting old entries (`components/canvas/canvas-context.tsx`).
  - Server hydration applies the same normalization prior to merging panels into `dataStore`, `branchesMap`, and `LayerManager`, while upgrading legacy keys in place (`lib/hooks/use-canvas-hydration.ts`).
- Audited the “ghost panel” scenario and captured the root cause plus long-term fix plan in `docs/proposal/canvas_state_persistence/fixes/ghost_panel/fix-report.md`; confirmed the panel-reappearance bug is still unresolved pending state filtering/workspace lifecycle changes.
- Logged before/after queries against `debug_logs` to confirm `branch_not_found` entries disappear once normalized keys flow through.
- Captured the resolution in `docs/proposal/canvas_state_persistence/fixes/connection_lines_issue_when_app_is_reload/FIX_REPORT.md`.

## Observations
- Phase 1 plumbing is ready for the remaining client-side work: API responses now surface the workspace version, but consumers still need to cache/compare it before using snapshots.
- After normalization, reloads consistently draw connection lines; the earlier “every other reload” failure no longer reproduces.
- TypeScript still flags unrelated issues in `components/canvas/canvas-panel.tsx` (pre-existing errors about `DataStore.keys`), so `npm run type-check` remains red.
- Existing logs show legacy rows in `panels` still contain raw UUID IDs; the UI now overwrites them in-memory, but a DB cleanup/migration would keep persistence consistent.
- Ghost panel issue remains open: lingering panel rows (`state='active'`) plus workspace/localStorage rehydration continue to re-insert closed panels. No state filtering or lifecycle persistence has been shipped yet, so “ghost” panels will keep returning until the fix plan in `ghost_panel/fix-report.md` is implemented.

## Next Steps
1. Apply the new migration in lower environments (`npm run db:migrate`) and backfill any existing `canvas_workspace_notes` rows if needed.
2. Gate localStorage/IndexedDB consumption on the returned workspace version (Phase 2) and align the offline queue before expanding further.
3. Complete Phase 3 reconciliation: discard stale snapshots automatically, remove the banner, and ensure telemetry covers cache hits/mismatches.
4. Address the outstanding `canvas-panel.tsx` type errors so `npm run type-check` passes again.
5. Optionally backfill the `panels` table to normalize stored IDs once the workspace reconciliation is in place, then prune the extra debug logging added during earlier investigations.

## Current Status
- Local branch contains normalization fixes; verified manually and via `debug_logs` queries.
- Connection lines persist across reloads without user interaction.
- Ghost-panel bug is documented but still unresolved; Phase 1 versioning is complete, pending the Phase 2/3 client changes outlined in `plan/worksspace_architecture/ghost_panel_remedy.md`.
- Outstanding TODOs: apply the migration, finish versions-aware cache handling and reconciliation, clean up the `panels` table (optional), and fix existing TypeScript warnings in `canvas-panel.tsx`.
