<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard v4 - Unified Canvas System</title>
  <style>
    :root {
      --bg-dark: #0f1117;
      --bg-card: #1a1d24;
      --bg-panel: #1e222a;
      --bg-hover: #252830;
      --bg-canvas: #0a0c10;
      --bg-input: #12141a;
      --border: rgba(255,255,255,0.08);
      --border-panel: rgba(255,255,255,0.1);
      --border-focus: rgba(99,102,241,0.5);
      --text-primary: #f0f0f0;
      --text-secondary: #8b8fa3;
      --text-muted: #5c6070;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-dim: rgba(99,102,241,0.15);
      --accent-glow: rgba(99,102,241,0.3);
      --success: #22c55e;
      --success-dim: rgba(34,197,94,0.15);
      --warning: #f59e0b;
      --panel-shadow: 0 4px 24px rgba(0,0,0,0.4);
      --panel-shadow-hover: 0 8px 32px rgba(0,0,0,0.5);
      --panel-shadow-drag: 0 16px 48px rgba(99,102,241,0.25);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-canvas);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    /* ========== UNIFIED LAYOUT ========== */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* ========== TOP BAR (Same for Dashboard & Workspace) ========== */
    .topbar {
      height: 52px;
      background: rgba(15,17,23,0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .breadcrumb-item {
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .breadcrumb-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .breadcrumb-item.current {
      color: var(--text-primary);
      font-weight: 500;
    }

    .breadcrumb-separator {
      color: var(--text-muted);
    }

    .topbar-center {
      display: flex;
      gap: 4px;
    }

    .workspace-tab {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .workspace-tab:hover {
      background: var(--bg-hover);
    }

    .workspace-tab.active {
      background: var(--accent-dim);
      border-color: var(--accent-dim);
      color: var(--accent);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 7px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .btn-icon {
      width: 34px;
      height: 34px;
      padding: 0;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-secondary);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: var(--bg-card);
      color: var(--text-primary);
    }

    /* ========== CANVAS (Unified - used by both Dashboard & Workspace) ========== */
    .canvas-container {
      flex: 1;
      position: relative;
      overflow: auto; /* KEY: Can scroll */
    }

    .canvas-surface {
      position: relative;
      min-width: 100%;
      min-height: 100%;
      width: 3000px;
      height: 2000px;
      background:
        radial-gradient(circle at 400px 300px, rgba(99,102,241,0.04) 0%, transparent 50%),
        linear-gradient(var(--bg-canvas) 1px, transparent 1px),
        linear-gradient(90deg, var(--bg-canvas) 1px, transparent 1px),
        linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 100% 100%, 100px 100px, 100px 100px, 20px 20px, 20px 20px;
    }

    /* ========== PANELS (Unified - all panel types) ========== */
    .panel {
      position: absolute;
      background: var(--bg-panel);
      border: 1px solid var(--border-panel);
      border-radius: 12px;
      box-shadow: var(--panel-shadow);
      display: flex;
      flex-direction: column;
      min-width: 220px;
      max-width: 450px;
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .panel:hover {
      border-color: rgba(255,255,255,0.15);
      box-shadow: var(--panel-shadow-hover);
    }

    .panel.dragging {
      box-shadow: var(--panel-shadow-drag);
      border-color: var(--accent);
      z-index: 1000;
      cursor: grabbing;
    }

    .panel-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      user-select: none;
      border-radius: 12px 12px 0 0;
    }

    .panel-header:active { cursor: grabbing; }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .panel-title-icon {
      font-size: 14px;
      opacity: 0.8;
    }

    .panel-type-badge {
      font-size: 10px;
      padding: 2px 6px;
      background: var(--bg-hover);
      border-radius: 4px;
      color: var(--text-muted);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .panel-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .panel:hover .panel-actions { opacity: 1; }

    .panel-action {
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 12px;
    }

    .panel-action:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .panel-content {
      padding: 14px;
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
    }

    /* ========== PANEL TYPE: Continue ========== */
    .panel-continue .panel-content {
      padding: 16px;
    }

    .continue-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: linear-gradient(135deg, var(--bg-hover) 0%, var(--accent-dim) 100%);
      border: 1px solid var(--accent-dim);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .continue-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .continue-icon {
      width: 44px;
      height: 44px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .continue-info { flex: 1; }

    .continue-label {
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .continue-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .continue-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ========== PANEL TYPE: Entry Navigator ========== */
    .entry-item {
      margin-bottom: 4px;
    }

    .entry-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      margin: 0 -10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .entry-header:hover { background: var(--bg-hover); }

    .entry-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 10px;
      transition: transform 0.15s;
    }

    .entry-item.expanded .entry-toggle { transform: rotate(90deg); }

    .entry-icon {
      width: 26px;
      height: 26px;
      background: var(--bg-hover);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .entry-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }

    .entry-children {
      display: none;
      padding-left: 24px;
      margin-top: 2px;
    }

    .entry-item.expanded .entry-children { display: block; }

    .workspace-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin: 2px -10px 2px 0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      transition: all 0.15s;
    }

    .workspace-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .workspace-item.current {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .workspace-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.5;
    }

    .workspace-item.current .workspace-dot { opacity: 1; }

    /* ========== PANEL TYPE: Recent ========== */
    .recent-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      margin: 0 -12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .recent-item:hover { background: var(--bg-hover); }

    .recent-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recent-item-icon {
      width: 28px;
      height: 28px;
      background: var(--bg-hover);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }

    .recent-item-name {
      font-size: 13px;
      font-weight: 500;
    }

    .recent-item-entry {
      font-size: 11px;
      color: var(--text-muted);
    }

    .recent-item-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== PANEL TYPE: Quick Capture ========== */
    .capture-input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: var(--text-primary);
      resize: none;
      min-height: 80px;
      font-family: inherit;
      line-height: 1.5;
    }

    .capture-input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .capture-input::placeholder { color: var(--text-muted); }

    .capture-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .capture-dest {
      font-size: 11px;
      color: var(--text-muted);
    }

    .capture-btn {
      padding: 6px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .capture-btn:hover { background: var(--accent-hover); }

    /* ========== PANEL TYPE: Note (with highlight-to-link) ========== */
    .note-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
      min-height: 100px;
      outline: none;
    }

    .note-content:focus {
      color: var(--text-primary);
    }

    .note-content p { margin-bottom: 8px; }
    .note-content p:last-child { margin-bottom: 0; }

    .note-content h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 16px 0 8px 0;
    }

    .note-content h3:first-child { margin-top: 0; }

    .workspace-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 10px;
      background: var(--accent-dim);
      color: var(--accent);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s;
    }

    .workspace-link:hover {
      background: var(--accent);
      color: white;
    }

    /* Highlight-to-Link Toolbar */
    .link-toolbar {
      position: fixed;
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 2000;
    }

    .link-toolbar.visible { display: flex; }

    .link-toolbar-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .link-toolbar-btn:hover {
      background: var(--accent-dim);
      color: var(--accent);
    }

    /* Workspace Picker */
    .workspace-picker {
      position: fixed;
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 280px;
      max-height: 320px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 2001;
    }

    .workspace-picker.visible { display: block; }

    .picker-search {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    .picker-search input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-primary);
    }

    .picker-search input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .picker-search input::placeholder { color: var(--text-muted); }

    .picker-list {
      max-height: 250px;
      overflow-y: auto;
      padding: 8px;
    }

    .picker-section-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 8px 4px;
    }

    .picker-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .picker-item:hover { background: var(--bg-hover); }

    .picker-item-icon {
      width: 24px;
      height: 24px;
      background: var(--bg-hover);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    .picker-item-info { flex: 1; }

    .picker-item-name {
      font-size: 13px;
      font-weight: 500;
    }

    .picker-item-path {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== FLOATING TOOLBAR ========== */
    .floating-toolbar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 8px 12px;
      display: flex;
      gap: 4px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      z-index: 100;
    }

    .toolbar-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 18px;
      transition: all 0.15s;
      position: relative;
    }

    .toolbar-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .toolbar-btn.active {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .toolbar-divider {
      width: 1px;
      background: var(--border);
      margin: 6px 6px;
    }

    /* Add Panel Dropdown */
    .add-panel-dropdown {
      position: absolute;
      bottom: 52px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      min-width: 200px;
      display: none;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    }

    .add-panel-dropdown.visible { display: block; }

    .add-panel-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .add-panel-item:hover { background: var(--bg-hover); }

    .add-panel-item-icon {
      font-size: 16px;
      width: 24px;
      text-align: center;
    }

    .add-panel-item-name {
      font-size: 13px;
      font-weight: 500;
    }

    .add-panel-item-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== KEYBOARD HINTS ========== */
    .keyboard-hints {
      position: fixed;
      bottom: 24px;
      left: 24px;
      display: flex;
      gap: 16px;
      z-index: 50;
    }

    .hint {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .hint-key {
      padding: 2px 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: monospace;
      font-size: 10px;
    }

    /* ========== MINIMAP ========== */
    .minimap {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 150px;
      height: 100px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      z-index: 50;
    }

    .minimap-viewport {
      position: absolute;
      border: 2px solid var(--accent);
      background: rgba(99,102,241,0.1);
      border-radius: 2px;
    }

    .minimap-panel {
      position: absolute;
      background: var(--bg-hover);
      border-radius: 1px;
    }

    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 14px;
      box-shadow: 0 4px 24px var(--accent-glow);
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* ========== HOME INDICATOR ========== */
    .home-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: var(--accent-dim);
      border-radius: 4px;
      font-size: 10px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Top Bar -->
    <nav class="topbar">
      <div class="topbar-left">
        <div class="logo" onclick="goToHome()" title="Home">A</div>
        <div class="breadcrumb" id="breadcrumb">
          <!-- Populated by JS -->
        </div>
      </div>
      <div class="topbar-center" id="workspace-tabs">
        <!-- Populated by JS -->
      </div>
      <div class="topbar-right">
        <button class="btn btn-ghost" onclick="showHelp()">?</button>
      </div>
    </nav>

    <!-- Canvas (Unified for Dashboard & Workspace) -->
    <div class="canvas-container" id="canvas-container">
      <div class="canvas-surface" id="canvas-surface">
        <!-- Panels rendered by JS -->
      </div>
    </div>

    <!-- Floating Toolbar -->
    <div class="floating-toolbar">
      <button class="toolbar-btn" title="Select (V)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
        </svg>
      </button>
      <button class="toolbar-btn" title="Pan (Space)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
        </svg>
      </button>
      <div class="toolbar-divider"></div>
      <button class="toolbar-btn" id="add-panel-btn" onclick="toggleAddPanel()" title="Add Panel (+)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M12 8v8M8 12h8"/>
        </svg>
      </button>
      <div class="add-panel-dropdown" id="add-panel-dropdown">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- Keyboard Hints -->
    <div class="keyboard-hints">
      <div class="hint"><span class="hint-key">H</span> Home</div>
      <div class="hint"><span class="hint-key">+</span> Add Panel</div>
      <div class="hint"><span class="hint-key">Cmd+K</span> Link</div>
    </div>

    <!-- Minimap -->
    <div class="minimap" id="minimap">
      <div class="minimap-viewport" id="minimap-viewport"></div>
    </div>
  </div>

  <!-- Link Toolbar (appears on text selection) -->
  <div class="link-toolbar" id="link-toolbar">
    <button class="link-toolbar-btn" onclick="showWorkspacePicker()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
      Link to Workspace
    </button>
  </div>

  <!-- Workspace Picker -->
  <div class="workspace-picker" id="workspace-picker">
    <div class="picker-search">
      <input type="text" placeholder="Search workspaces..." id="picker-search-input" oninput="filterPicker(this.value)">
    </div>
    <div class="picker-list" id="picker-list">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ========== DATA ==========
    const entries = [
      {
        id: "home",
        name: "Home",
        icon: "H",
        isSystem: true,
        workspaces: [
          { id: "home-dashboard", name: "Dashboard", isDefault: true }
        ]
      },
      {
        id: "alpha",
        name: "Project Alpha",
        icon: "A",
        workspaces: [
          { id: "alpha-default", name: "Default", isDefault: true },
          { id: "alpha-planning", name: "Planning" },
          { id: "alpha-research", name: "Research" }
        ]
      },
      {
        id: "beta",
        name: "Project Beta",
        icon: "B",
        workspaces: [
          { id: "beta-default", name: "Default", isDefault: true },
          { id: "beta-drafts", name: "Drafts" }
        ]
      },
      {
        id: "ideas",
        name: "Ideas Inbox",
        icon: "I",
        workspaces: [
          { id: "ideas-default", name: "Default", isDefault: true }
        ]
      }
    ];

    // Panel types available
    const panelTypes = [
      { id: "note", name: "Note", icon: "üìù", desc: "Text note with links" },
      { id: "continue", name: "Continue", icon: "‚ñ∂", desc: "Resume last workspace" },
      { id: "navigator", name: "Entry Navigator", icon: "üìÅ", desc: "Browse entries" },
      { id: "recent", name: "Recent", icon: "üïê", desc: "Recent workspaces" },
      { id: "capture", name: "Quick Capture", icon: "‚úèÔ∏è", desc: "Capture ideas" }
    ];

    // Workspace panel configurations
    const workspacePanels = {
      "home-dashboard": [
        { id: "p1", type: "continue", x: 40, y: 40, width: 320 },
        { id: "p2", type: "navigator", x: 40, y: 200, width: 280 },
        { id: "p3", type: "recent", x: 380, y: 40, width: 280 },
        { id: "p4", type: "capture", x: 380, y: 260, width: 280 },
        { id: "p5", type: "note", x: 700, y: 40, width: 300,
          title: "Quick Links",
          content: `<h3>Daily Work</h3>
            <p><span class="workspace-link" data-target="alpha-planning">Planning</span> - main tasks</p>
            <p><span class="workspace-link" data-target="alpha-research">Research</span> - background</p>
            <h3>Side Projects</h3>
            <p><span class="workspace-link" data-target="beta-drafts">Beta Drafts</span> - experiments</p>`
        }
      ],
      "alpha-planning": [
        { id: "ap1", type: "note", x: 60, y: 60, width: 340,
          title: "Project Overview",
          content: `<p>Main planning document for Project Alpha.</p>
            <p>See <span class="workspace-link" data-target="alpha-research">Research</span> for background.</p>
            <p>Check <span class="workspace-link" data-target="beta-drafts">Beta Drafts</span> for related experiments.</p>`
        },
        { id: "ap2", type: "note", x: 450, y: 80, width: 300,
          title: "Timeline",
          content: `<p>Q1: Research & Discovery</p><p>Q2: Design & Prototype</p><p>Q3: Implementation</p><p>Q4: Launch</p>`
        }
      ],
      "alpha-research": [
        { id: "ar1", type: "note", x: 80, y: 60, width: 380,
          title: "Research Notes",
          content: `<p>User interviews revealed key insights...</p>
            <p>Back to <span class="workspace-link" data-target="alpha-planning">Planning</span> for next steps.</p>`
        }
      ]
    };

    // ========== STATE ==========
    let currentEntry = entries[0]; // Home
    let currentWorkspace = entries[0].workspaces[0]; // Dashboard
    let lastNonHomeWorkspace = { entry: entries[1], workspace: entries[1].workspaces[1] }; // Alpha/Planning
    let panels = [];
    let draggingPanel = null;
    let dragOffset = { x: 0, y: 0 };
    let selectedRange = null;
    let addPanelVisible = false;

    // ========== NAVIGATION ==========
    function goToHome() {
      navigateTo("home", "home-dashboard");
    }

    function navigateTo(entryId, workspaceId) {
      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;

      const workspace = entry.workspaces.find(w => w.id === workspaceId);
      if (!workspace) return;

      // Track last non-home workspace for Continue panel
      if (entryId !== "home") {
        lastNonHomeWorkspace = { entry, workspace };
      }

      currentEntry = entry;
      currentWorkspace = workspace;

      render();
      showToast(`${entry.name} / ${workspace.name}`);
    }

    function switchWorkspace(workspaceId) {
      const workspace = currentEntry.workspaces.find(w => w.id === workspaceId);
      if (workspace) {
        if (currentEntry.id !== "home") {
          lastNonHomeWorkspace = { entry: currentEntry, workspace };
        }
        currentWorkspace = workspace;
        render();
      }
    }

    // ========== RENDER ==========
    function render() {
      renderBreadcrumb();
      renderTabs();
      renderPanels();
      renderMinimap();
      renderAddPanelDropdown();
    }

    function renderBreadcrumb() {
      const bc = document.getElementById("breadcrumb");

      if (currentEntry.isSystem) {
        bc.innerHTML = `
          <span class="breadcrumb-item current">${currentEntry.name}</span>
          <span class="home-badge">System</span>
        `;
      } else {
        bc.innerHTML = `
          <span class="breadcrumb-item" onclick="goToHome()">Home</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item current">${currentEntry.name}</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item current">${currentWorkspace.name}</span>
        `;
      }
    }

    function renderTabs() {
      const tabs = document.getElementById("workspace-tabs");
      tabs.innerHTML = currentEntry.workspaces.map(ws => `
        <button class="workspace-tab ${ws.id === currentWorkspace.id ? 'active' : ''}"
                onclick="switchWorkspace('${ws.id}')">${ws.name}</button>
      `).join('');
    }

    function renderPanels() {
      const surface = document.getElementById("canvas-surface");
      panels = workspacePanels[currentWorkspace.id] || [];

      surface.innerHTML = panels.map((panel, idx) => {
        const type = panelTypes.find(t => t.id === panel.type);
        return `
          <div class="panel ${panel.type === 'continue' ? 'panel-continue' : ''}"
               id="panel-${panel.id}"
               data-index="${idx}"
               style="left:${panel.x}px;top:${panel.y}px;width:${panel.width}px">
            <div class="panel-header" onmousedown="startDrag(event, ${idx})">
              <span class="panel-title">
                <span class="panel-title-icon">${type?.icon || 'üì¶'}</span>
                ${panel.title || type?.name || 'Panel'}
              </span>
              <div class="panel-actions">
                <button class="panel-action" onclick="removePanel(${idx})" title="Remove">√ó</button>
              </div>
            </div>
            <div class="panel-content">${renderPanelContent(panel)}</div>
          </div>
        `;
      }).join('');

      // Add click handlers for workspace links
      document.querySelectorAll('.workspace-link').forEach(link => {
        link.onclick = () => {
          const target = link.dataset.target;
          if (target) {
            // Find workspace
            for (const entry of entries) {
              const ws = entry.workspaces.find(w => w.id === target);
              if (ws) {
                navigateTo(entry.id, ws.id);
                return;
              }
            }
          }
        };
      });

      // Setup contenteditable for note panels
      document.querySelectorAll('.note-content[contenteditable]').forEach(el => {
        el.addEventListener('mouseup', handleTextSelection);
      });
    }

    function renderPanelContent(panel) {
      switch (panel.type) {
        case 'continue':
          return `
            <div class="continue-card" onclick="navigateTo('${lastNonHomeWorkspace.entry.id}', '${lastNonHomeWorkspace.workspace.id}')">
              <div class="continue-icon">‚ñ∂</div>
              <div class="continue-info">
                <div class="continue-label">Continue where you left off</div>
                <div class="continue-title">${lastNonHomeWorkspace.entry.name} / ${lastNonHomeWorkspace.workspace.name}</div>
                <div class="continue-meta">Last edited 5 minutes ago</div>
              </div>
            </div>
          `;

        case 'navigator':
          return entries.filter(e => !e.isSystem).map(entry => `
            <div class="entry-item expanded">
              <div class="entry-header" onclick="this.parentElement.classList.toggle('expanded')">
                <span class="entry-toggle">‚ñ∏</span>
                <span class="entry-icon">${entry.icon}</span>
                <span class="entry-name">${entry.name}</span>
              </div>
              <div class="entry-children">
                ${entry.workspaces.map(ws => `
                  <div class="workspace-item ${currentEntry.id === entry.id && currentWorkspace.id === ws.id ? 'current' : ''}"
                       onclick="navigateTo('${entry.id}', '${ws.id}')">
                    <span class="workspace-dot"></span>
                    ${ws.name}
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('');

        case 'recent':
          const recentItems = [
            { entry: entries[1], workspace: entries[1].workspaces[1], time: '5m' },
            { entry: entries[2], workspace: entries[2].workspaces[1], time: '1h' },
            { entry: entries[3], workspace: entries[3].workspaces[0], time: '2d' },
            { entry: entries[1], workspace: entries[1].workspaces[2], time: '3d' }
          ];
          return recentItems.map(item => `
            <div class="recent-item" onclick="navigateTo('${item.entry.id}', '${item.workspace.id}')">
              <div class="recent-item-left">
                <div class="recent-item-icon">${item.entry.icon}</div>
                <div>
                  <div class="recent-item-name">${item.workspace.name}</div>
                  <div class="recent-item-entry">${item.entry.name}</div>
                </div>
              </div>
              <span class="recent-item-time">${item.time}</span>
            </div>
          `).join('');

        case 'capture':
          return `
            <textarea class="capture-input" placeholder="Capture a quick thought..."></textarea>
            <div class="capture-footer">
              <span class="capture-dest">‚Üí Ideas Inbox</span>
              <button class="capture-btn" onclick="captureNote()">Send</button>
            </div>
          `;

        case 'note':
          return `<div class="note-content" contenteditable="true">${panel.content || '<p>Start typing...</p>'}</div>`;

        default:
          return '<p>Unknown panel type</p>';
      }
    }

    function renderMinimap() {
      const minimap = document.getElementById('minimap');
      const viewport = document.getElementById('minimap-viewport');
      const container = document.getElementById('canvas-container');
      const surface = document.getElementById('canvas-surface');

      const scale = 150 / 3000;

      // Viewport indicator
      const vw = (container.clientWidth / 3000) * 150;
      const vh = (container.clientHeight / 2000) * 100;
      viewport.style.width = vw + 'px';
      viewport.style.height = vh + 'px';
      viewport.style.left = (container.scrollLeft / 3000) * 150 + 'px';
      viewport.style.top = (container.scrollTop / 2000) * 100 + 'px';

      // Panel indicators
      let panelIndicators = '';
      panels.forEach(panel => {
        const x = panel.x * scale;
        const y = panel.y * (100/2000);
        const w = panel.width * scale;
        const h = 15 * scale;
        panelIndicators += `<div class="minimap-panel" style="left:${x}px;top:${y}px;width:${w}px;height:${h}px"></div>`;
      });

      minimap.innerHTML = panelIndicators + `<div class="minimap-viewport" style="width:${vw}px;height:${vh}px;left:${(container.scrollLeft / 3000) * 150}px;top:${(container.scrollTop / 2000) * 100}px"></div>`;
    }

    function renderAddPanelDropdown() {
      const dropdown = document.getElementById('add-panel-dropdown');
      dropdown.innerHTML = panelTypes.map(type => `
        <div class="add-panel-item" onclick="addPanel('${type.id}')">
          <span class="add-panel-item-icon">${type.icon}</span>
          <div>
            <div class="add-panel-item-name">${type.name}</div>
            <div class="add-panel-item-desc">${type.desc}</div>
          </div>
        </div>
      `).join('');
    }

    // ========== PANEL OPERATIONS ==========
    function toggleAddPanel() {
      addPanelVisible = !addPanelVisible;
      document.getElementById('add-panel-dropdown').classList.toggle('visible', addPanelVisible);
      document.getElementById('add-panel-btn').classList.toggle('active', addPanelVisible);
    }

    function addPanel(typeId) {
      const container = document.getElementById('canvas-container');
      const newPanel = {
        id: 'p' + Date.now(),
        type: typeId,
        x: container.scrollLeft + 100 + Math.random() * 200,
        y: container.scrollTop + 100 + Math.random() * 100,
        width: 280
      };

      if (!workspacePanels[currentWorkspace.id]) {
        workspacePanels[currentWorkspace.id] = [];
      }
      workspacePanels[currentWorkspace.id].push(newPanel);

      toggleAddPanel();
      render();
      showToast(`Added ${panelTypes.find(t => t.id === typeId)?.name || 'panel'}`);
    }

    function removePanel(index) {
      workspacePanels[currentWorkspace.id].splice(index, 1);
      render();
    }

    function captureNote() {
      const input = document.querySelector('.capture-input');
      if (input && input.value.trim()) {
        showToast(`Captured: "${input.value.slice(0, 30)}..."`);
        input.value = '';
      }
    }

    // ========== DRAG & DROP ==========
    function startDrag(e, index) {
      if (e.target.closest('.panel-actions')) return;

      draggingPanel = document.querySelector(`[data-index="${index}"]`);
      draggingPanel.classList.add('dragging');

      const rect = draggingPanel.getBoundingClientRect();
      dragOffset = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };

      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
    }

    function onDrag(e) {
      if (!draggingPanel) return;

      const container = document.getElementById('canvas-container');
      const surface = document.getElementById('canvas-surface');
      const containerRect = container.getBoundingClientRect();

      let x = e.clientX - containerRect.left + container.scrollLeft - dragOffset.x;
      let y = e.clientY - containerRect.top + container.scrollTop - dragOffset.y;

      x = Math.max(0, x);
      y = Math.max(0, y);

      draggingPanel.style.left = x + 'px';
      draggingPanel.style.top = y + 'px';

      // Update data
      const index = parseInt(draggingPanel.dataset.index);
      if (workspacePanels[currentWorkspace.id] && workspacePanels[currentWorkspace.id][index]) {
        workspacePanels[currentWorkspace.id][index].x = x;
        workspacePanels[currentWorkspace.id][index].y = y;
      }

      renderMinimap();
    }

    function stopDrag() {
      if (draggingPanel) {
        draggingPanel.classList.remove('dragging');
        draggingPanel = null;
      }
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
    }

    // ========== HIGHLIGHT-TO-LINK ==========
    function handleTextSelection(e) {
      const selection = window.getSelection();
      const text = selection.toString().trim();

      if (text.length > 0) {
        selectedRange = selection.getRangeAt(0).cloneRange();
        showLinkToolbar(e.clientX, e.clientY);
      } else {
        hideLinkToolbar();
      }
    }

    function showLinkToolbar(x, y) {
      const toolbar = document.getElementById('link-toolbar');
      toolbar.style.left = x + 'px';
      toolbar.style.top = (y - 40) + 'px';
      toolbar.classList.add('visible');
    }

    function hideLinkToolbar() {
      document.getElementById('link-toolbar').classList.remove('visible');
      document.getElementById('workspace-picker').classList.remove('visible');
    }

    function showWorkspacePicker() {
      const toolbar = document.getElementById('link-toolbar');
      const picker = document.getElementById('workspace-picker');

      const rect = toolbar.getBoundingClientRect();
      picker.style.left = rect.left + 'px';
      picker.style.top = (rect.bottom + 8) + 'px';
      picker.classList.add('visible');

      renderPickerList('');
      document.getElementById('picker-search-input').focus();
    }

    function renderPickerList(filter) {
      const list = document.getElementById('picker-list');
      const lowerFilter = filter.toLowerCase();

      let html = '<div class="picker-section-label">Recent</div>';

      // Recent workspaces
      const recent = [
        { entry: entries[1], workspace: entries[1].workspaces[1] },
        { entry: entries[1], workspace: entries[1].workspaces[2] },
        { entry: entries[2], workspace: entries[2].workspaces[1] }
      ];

      recent.forEach(({ entry, workspace }) => {
        if (!filter || workspace.name.toLowerCase().includes(lowerFilter) || entry.name.toLowerCase().includes(lowerFilter)) {
          html += `
            <div class="picker-item" onclick="createLink('${entry.id}', '${workspace.id}', '${workspace.name}')">
              <div class="picker-item-icon">${entry.icon}</div>
              <div class="picker-item-info">
                <div class="picker-item-name">${workspace.name}</div>
                <div class="picker-item-path">${entry.name}</div>
              </div>
            </div>
          `;
        }
      });

      html += '<div class="picker-section-label">All Workspaces</div>';

      entries.filter(e => !e.isSystem).forEach(entry => {
        entry.workspaces.forEach(ws => {
          if (!filter || ws.name.toLowerCase().includes(lowerFilter) || entry.name.toLowerCase().includes(lowerFilter)) {
            html += `
              <div class="picker-item" onclick="createLink('${entry.id}', '${ws.id}', '${ws.name}')">
                <div class="picker-item-icon">${entry.icon}</div>
                <div class="picker-item-info">
                  <div class="picker-item-name">${ws.name}</div>
                  <div class="picker-item-path">${entry.name}</div>
                </div>
              </div>
            `;
          }
        });
      });

      list.innerHTML = html;
    }

    function filterPicker(value) {
      renderPickerList(value);
    }

    function createLink(entryId, workspaceId, displayName) {
      if (!selectedRange) return;

      const link = document.createElement('span');
      link.className = 'workspace-link';
      link.dataset.target = workspaceId;
      link.textContent = selectedRange.toString();
      link.onclick = () => navigateTo(entryId, workspaceId);

      selectedRange.deleteContents();
      selectedRange.insertNode(link);

      hideLinkToolbar();
      showToast(`Linked to ${displayName}`);
    }

    // ========== UTILITIES ==========
    function showToast(message) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('visible');
      setTimeout(() => toast.classList.remove('visible'), 2000);
    }

    function showHelp() {
      alert(`Dashboard v4 - Unified Canvas System

KEY CONCEPT:
Dashboard is just a workspace in the "Home" entry.
Same canvas, same panels, same interactions.

NAVIGATION:
‚Ä¢ Click logo or press H ‚Üí Home/Dashboard
‚Ä¢ Click breadcrumb to navigate
‚Ä¢ Use workspace tabs to switch

PANELS:
‚Ä¢ Drag headers to move panels
‚Ä¢ Click + to add new panels
‚Ä¢ All panel types work everywhere

HIGHLIGHT-TO-LINK:
1. Select text in a note panel
2. Click "Link to Workspace"
3. Pick a workspace
4. Text becomes clickable link

KEYBOARD:
‚Ä¢ H - Go to Home/Dashboard
‚Ä¢ + - Add panel menu
‚Ä¢ Cmd+K - Link selected text`);
    }

    // ========== KEYBOARD ==========
    document.addEventListener('keydown', (e) => {
      if (e.key === 'h' || e.key === 'H') {
        if (!e.target.closest('[contenteditable]') && !e.target.closest('input') && !e.target.closest('textarea')) {
          goToHome();
        }
      }
      if (e.key === '+' || e.key === '=') {
        if (!e.target.closest('[contenteditable]') && !e.target.closest('input') && !e.target.closest('textarea')) {
          toggleAddPanel();
        }
      }
      if (e.key === 'Escape') {
        hideLinkToolbar();
        if (addPanelVisible) toggleAddPanel();
      }
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        const selection = window.getSelection();
        if (selection.toString().trim()) {
          showWorkspacePicker();
        }
      }
    });

    // Close picker when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.workspace-picker') && !e.target.closest('.link-toolbar')) {
        hideLinkToolbar();
      }
      if (!e.target.closest('.add-panel-dropdown') && !e.target.closest('#add-panel-btn')) {
        if (addPanelVisible) toggleAddPanel();
      }
    });

    // Update minimap on scroll
    document.getElementById('canvas-container').addEventListener('scroll', renderMinimap);

    // ========== INIT ==========
    render();
  </script>
</body>
</html>
