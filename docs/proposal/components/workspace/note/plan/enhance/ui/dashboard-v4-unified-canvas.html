<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard v4 - Entry-Workspace Hierarchy Demo</title>
  <style>
    :root {
      --bg-dark: #0f1117;
      --bg-card: #1a1d24;
      --bg-panel: #1e222a;
      --bg-hover: #252830;
      --bg-canvas: #0a0c10;
      --bg-input: #12141a;
      --border: rgba(255,255,255,0.08);
      --border-panel: rgba(255,255,255,0.1);
      --border-focus: rgba(99,102,241,0.5);
      --text-primary: #f0f0f0;
      --text-secondary: #8b8fa3;
      --text-muted: #5c6070;
      --accent: #6366f1;
      --accent-hover: #818cf8;
      --accent-dim: rgba(99,102,241,0.15);
      --accent-glow: rgba(99,102,241,0.3);
      --success: #22c55e;
      --success-dim: rgba(34,197,94,0.15);
      --warning: #f59e0b;
      --panel-shadow: 0 4px 24px rgba(0,0,0,0.4);
      --panel-shadow-hover: 0 8px 32px rgba(0,0,0,0.5);
      --panel-shadow-drag: 0 16px 48px rgba(99,102,241,0.25);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-canvas);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }

    /* ========== UNIFIED LAYOUT ========== */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    .main-content {
      display: flex;
      flex: 1;
      min-height: 0;
    }

    .entry-sidebar {
      width: 260px;
      background: rgba(17,19,26,0.9);
      border-right: 1px solid var(--border);
      padding: 20px 16px;
      overflow-y: auto;
    }

    .entry-sidebar h3 {
      font-size: 13px;
      color: var(--text-muted);
      letter-spacing: 0.08em;
      margin-bottom: 18px;
      text-transform: uppercase;
    }

    .entry-group {
      margin-bottom: 20px;
    }

    .entry-root {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
      font-weight: 600;
      margin-bottom: 10px;
    }

    .entry-node {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 10px;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 13px;
      transition: all 0.15s;
    }

    .entry-node:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .entry-node.active {
      background: var(--accent-dim);
      color: var(--accent);
      border: 1px solid var(--accent-dim);
    }

    .entry-node span {
      font-size: 11px;
      color: var(--text-muted);
    }

    .entry-summary {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== TOP BAR ========== */
    .topbar {
      height: 52px;
      background: rgba(15,17,23,0.95);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      flex-shrink: 0;
      z-index: 100;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent) 0%, #8b5cf6 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      cursor: pointer;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .breadcrumb-item {
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      transition: all 0.15s;
    }

    .breadcrumb-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .breadcrumb-item.current {
      color: var(--text-primary);
      font-weight: 500;
    }

    .breadcrumb-separator {
      color: var(--text-muted);
    }

    .topbar-center {
      display: flex;
      gap: 4px;
    }

    .workspace-tab {
      padding: 6px 14px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .workspace-tab:hover {
      background: var(--bg-hover);
    }

    .workspace-tab.active {
      background: var(--accent-dim);
      border-color: var(--accent-dim);
      color: var(--accent);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ========== NOTIFICATION CENTER ========== */
    .notification-bell {
      position: relative;
      width: 36px;
      height: 36px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      transition: all 0.15s;
    }

    .notification-bell:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .notification-bell.has-unread {
      border-color: var(--accent);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: #ef4444;
      color: white;
      font-size: 10px;
      font-weight: 700;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 5px;
    }

    .notification-panel {
      position: fixed;
      top: 52px;
      right: 16px;
      width: 400px;
      max-height: calc(100vh - 80px);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 1000;
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .notification-panel.visible {
      display: flex;
    }

    .notification-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .notification-header-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .notification-header-title {
      font-size: 14px;
      font-weight: 600;
    }

    .notification-header-count {
      font-size: 12px;
      color: var(--text-muted);
    }

    .notification-header-actions {
      display: flex;
      gap: 8px;
    }

    .notification-header-btn {
      padding: 5px 10px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .notification-header-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .notification-filters {
      padding: 10px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      gap: 6px;
    }

    .notification-filter {
      padding: 5px 12px;
      background: transparent;
      border: 1px solid transparent;
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .notification-filter:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }

    .notification-filter.active {
      background: var(--accent-dim);
      border-color: rgba(99,102,241,0.3);
      color: var(--accent);
    }

    .notification-list {
      flex: 1;
      overflow-y: auto;
      max-height: 500px;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      transition: background 0.15s;
    }

    .notification-item:hover {
      background: var(--bg-hover);
    }

    .notification-item.unread {
      background: rgba(99,102,241,0.05);
    }

    .notification-item.unread:hover {
      background: rgba(99,102,241,0.1);
    }

    .notification-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .notification-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .notification-icon.error {
      background: rgba(239,68,68,0.15);
      color: #ef4444;
    }

    .notification-icon.warning {
      background: rgba(245,158,11,0.15);
      color: #f59e0b;
    }

    .notification-icon.success {
      background: rgba(34,197,94,0.15);
      color: #22c55e;
    }

    .notification-icon.info {
      background: rgba(59,130,246,0.15);
      color: #3b82f6;
    }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-title {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 2px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .notification-title .unread-dot {
      width: 6px;
      height: 6px;
      background: var(--accent);
      border-radius: 50%;
    }

    .notification-desc {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .notification-details-toggle {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 4px;
      flex-shrink: 0;
    }

    .notification-details-toggle:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .notification-details-toggle.expanded {
      background: var(--accent-dim);
      border-color: var(--accent);
      color: var(--accent);
    }

    .notification-details {
      display: none;
      margin-top: 10px;
      padding: 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
    }

    .notification-details.visible {
      display: block;
    }

    .notification-details-row {
      display: flex;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .notification-details-row:last-child {
      margin-bottom: 0;
    }

    .notification-details-label {
      color: var(--text-muted);
      width: 120px;
      flex-shrink: 0;
    }

    .notification-details-value {
      color: var(--text-primary);
      word-break: break-word;
    }

    .notification-details-value.action {
      color: var(--accent);
      font-weight: 500;
    }

    .notification-details-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .notification-details-btn {
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .notification-details-btn.primary {
      background: var(--accent);
      border: none;
      color: white;
    }

    .notification-details-btn.primary:hover {
      background: var(--accent-hover);
    }

    .notification-details-btn.secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
    }

    .notification-details-btn.secondary:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    .notification-empty-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .notification-empty-text {
      font-size: 13px;
    }

    .btn {
      padding: 7px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.15s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border);
    }

    .btn-ghost:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    /* ========== CANVAS ========== */
    .canvas-container {
      flex: 1;
      position: relative;
      overflow: auto;
    }

    .canvas-surface {
      position: relative;
      min-width: 100%;
      min-height: 100%;
      width: 3000px;
      height: 2000px;
      background:
        radial-gradient(circle at 400px 300px, rgba(99,102,241,0.04) 0%, transparent 50%),
        linear-gradient(var(--bg-canvas) 1px, transparent 1px),
        linear-gradient(90deg, var(--bg-canvas) 1px, transparent 1px),
        linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px),
        linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px);
      background-size: 100% 100%, 100px 100px, 100px 100px, 20px 20px, 20px 20px;
    }

    /* ========== PANELS ========== */
    .panel {
      position: absolute;
      background: var(--bg-panel);
      border: 1px solid var(--border-panel);
      border-radius: 12px;
      box-shadow: var(--panel-shadow);
      display: flex;
      flex-direction: column;
      min-width: 220px;
      max-width: 450px;
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .panel:hover {
      border-color: rgba(255,255,255,0.15);
      box-shadow: var(--panel-shadow-hover);
    }

    .panel.dragging {
      box-shadow: var(--panel-shadow-drag);
      border-color: var(--accent);
      z-index: 1000;
      cursor: grabbing;
    }

    .panel-header {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: grab;
      user-select: none;
      border-radius: 12px 12px 0 0;
    }

    .panel-header:active { cursor: grabbing; }

    .panel-title {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .panel-title-icon {
      font-size: 14px;
      opacity: 0.8;
    }

    .panel-actions {
      display: flex;
      gap: 2px;
      opacity: 0;
      transition: opacity 0.15s;
    }

    .panel:hover .panel-actions { opacity: 1; }

    .panel-action {
      width: 24px;
      height: 24px;
      background: transparent;
      border: none;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      font-size: 12px;
    }

    .panel-action:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .panel-content {
      padding: 14px;
      flex: 1;
      overflow-y: auto;
      max-height: 400px;
    }

    /* ========== PANEL TYPE: Continue ========== */
    .panel-continue .panel-content {
      padding: 16px;
    }

    .continue-card {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: linear-gradient(135deg, var(--bg-hover) 0%, var(--accent-dim) 100%);
      border: 1px solid var(--accent-dim);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .continue-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }

    .continue-icon {
      width: 44px;
      height: 44px;
      background: var(--accent);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      color: white;
    }

    .continue-info { flex: 1; }

    .continue-label {
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .continue-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .continue-meta {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ========== PANEL TYPE: Entry Navigator ========== */
    .entry-item {
      margin-bottom: 4px;
    }

    .entry-header {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 10px;
      margin: 0 -10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .entry-header:hover { background: var(--bg-hover); }

    /* Active entry highlighting */
    .entry-item.active > .entry-header {
      background: var(--accent-dim);
      border: 1px solid rgba(99,102,241,0.3);
      margin: 0 -11px;
    }

    .entry-item.active > .entry-header .entry-name {
      color: var(--accent);
      font-weight: 600;
    }

    .entry-toggle {
      width: 16px;
      height: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 10px;
      transition: transform 0.15s;
    }

    .entry-item.expanded .entry-toggle { transform: rotate(90deg); }

    .entry-icon {
      width: 26px;
      height: 26px;
      background: var(--bg-hover);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }

    .entry-item.active .entry-icon {
      background: var(--accent);
      color: white;
    }

    .entry-name {
      flex: 1;
      font-size: 13px;
      font-weight: 500;
    }

    .entry-children {
      display: none;
      padding-left: 24px;
      margin-top: 2px;
    }

    .entry-item.expanded .entry-children { display: block; }

    .workspace-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      margin: 2px -10px 2px 0;
      border-radius: 6px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-secondary);
      transition: all 0.15s;
    }

    .workspace-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .workspace-item.current {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .workspace-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      opacity: 0.5;
    }

    .workspace-item.current .workspace-dot { opacity: 1; }

    /* ========== PANEL TYPE: Recent ========== */
    .recent-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      margin: 0 -12px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .recent-item:hover { background: var(--bg-hover); }

    .recent-item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .recent-item-icon {
      width: 28px;
      height: 28px;
      background: var(--bg-hover);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }

    .recent-item-name {
      font-size: 13px;
      font-weight: 500;
    }

    .recent-item-entry {
      font-size: 11px;
      color: var(--text-muted);
    }

    .recent-item-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== PANEL TYPE: Quick Capture ========== */
    .capture-input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      font-size: 13px;
      color: var(--text-primary);
      resize: none;
      min-height: 80px;
      font-family: inherit;
      line-height: 1.5;
    }

    .capture-input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .capture-input::placeholder { color: var(--text-muted); }

    .capture-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: 10px;
    }

    .capture-dest {
      font-size: 11px;
      color: var(--text-muted);
    }

    .capture-btn {
      padding: 6px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .capture-btn:hover { background: var(--accent-hover); }

    /* ========== PANEL TYPE: Quick Links Note ========== */
    .note-content {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
      min-height: 100px;
      outline: none;
    }

    .note-content:focus {
      color: var(--text-primary);
    }

    .note-content p { margin-bottom: 8px; }
    .note-content p:last-child { margin-bottom: 0; }

    .note-content h3 {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 16px 0 8px 0;
    }

    .note-content h3:first-child { margin-top: 0; }

    .workspace-link {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 10px;
      background: var(--accent-dim);
      color: var(--accent);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.15s;
    }

    .workspace-link:hover {
      background: var(--accent);
      color: white;
    }

    /* New link being created */
    .workspace-link.new {
      background: var(--success-dim);
      color: var(--success);
      animation: pulse 1s ease-in-out;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Highlight-to-Link Toolbar */
    .link-toolbar {
      position: fixed;
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 4px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.4);
      z-index: 2000;
    }

    .link-toolbar.visible { display: flex; }

    .link-toolbar-btn {
      padding: 6px 12px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .link-toolbar-btn:hover {
      background: var(--accent-dim);
      color: var(--accent);
    }

    /* Workspace Picker */
    .workspace-picker {
      position: fixed;
      display: none;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      width: 300px;
      max-height: 380px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      z-index: 2001;
    }

    .workspace-picker.visible { display: block; }

    .picker-header {
      padding: 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .picker-header-icon {
      color: var(--accent);
    }

    .picker-header-title {
      font-size: 13px;
      font-weight: 600;
    }

    .picker-header-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      padding: 4px;
    }

    .picker-selected-text {
      padding: 8px 12px;
      font-size: 12px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .picker-selected-text span {
      color: var(--text-primary);
    }

    .picker-search {
      padding: 12px;
      border-bottom: 1px solid var(--border);
    }

    .picker-search input {
      width: 100%;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 13px;
      color: var(--text-primary);
    }

    .picker-search input:focus {
      outline: none;
      border-color: var(--border-focus);
    }

    .picker-search input::placeholder { color: var(--text-muted); }

    /* Entry filter toggle */
    .picker-filter {
      padding: 8px 12px;
      display: flex;
      gap: 8px;
      border-bottom: 1px solid var(--border);
    }

    .filter-btn {
      padding: 4px 10px;
      font-size: 11px;
      border-radius: 4px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .filter-btn.active {
      background: var(--accent-dim);
      color: var(--accent);
      border-color: rgba(99,102,241,0.3);
    }

    .picker-list {
      max-height: 220px;
      overflow-y: auto;
      padding: 8px;
    }

    .picker-section-label {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 8px 4px;
    }

    .picker-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .picker-item:hover { background: var(--bg-hover); }

    .picker-item-icon {
      width: 24px;
      height: 24px;
      background: var(--bg-hover);
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
    }

    .picker-item-info { flex: 1; }

    .picker-item-name {
      font-size: 13px;
      font-weight: 500;
    }

    .picker-item-path {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Create new workspace option */
    .picker-create {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      margin: 4px 8px 8px;
      background: var(--success-dim);
      border: 1px solid rgba(34,197,94,0.3);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .picker-create:hover {
      background: rgba(34,197,94,0.25);
      border-color: var(--success);
    }

    .picker-create-icon {
      width: 24px;
      height: 24px;
      background: var(--success);
      color: white;
      border-radius: 5px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
    }

    .picker-create-text {
      font-size: 13px;
      font-weight: 500;
      color: var(--success);
    }

    .picker-create-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* ========== FLOATING TOOLBAR ========== */
    .floating-toolbar {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 8px 12px;
      display: flex;
      gap: 4px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.4);
      z-index: 100;
    }

    .toolbar-btn {
      width: 40px;
      height: 40px;
      background: transparent;
      border: none;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 18px;
      transition: all 0.15s;
      position: relative;
    }

    .toolbar-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .toolbar-btn.active {
      background: var(--accent-dim);
      color: var(--accent);
    }

    .toolbar-divider {
      width: 1px;
      background: var(--border);
      margin: 6px 6px;
    }

    /* ========== KEYBOARD HINTS ========== */
    .keyboard-hints {
      position: fixed;
      bottom: 24px;
      left: 24px;
      display: flex;
      gap: 16px;
      z-index: 50;
    }

    .hint {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-muted);
    }

    .hint-key {
      padding: 2px 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-family: monospace;
      font-size: 10px;
    }

    /* ========== MINIMAP ========== */
    .minimap {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 150px;
      height: 100px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      z-index: 50;
    }

    .minimap-viewport {
      position: absolute;
      border: 2px solid var(--accent);
      background: rgba(99,102,241,0.1);
      border-radius: 2px;
    }

    .minimap-panel {
      position: absolute;
      background: var(--bg-hover);
      border-radius: 1px;
    }

    /* ========== TOAST ========== */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--bg-card);
      border: 1px solid var(--accent);
      border-radius: 10px;
      padding: 12px 20px;
      font-size: 14px;
      box-shadow: 0 4px 24px var(--accent-glow);
      z-index: 3000;
      opacity: 0;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    .toast.visible {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    .toast.success {
      border-color: var(--success);
      box-shadow: 0 4px 24px rgba(34,197,94,0.3);
    }

    /* ========== HOME INDICATOR ========== */
    .home-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      background: var(--accent-dim);
      border-radius: 4px;
      font-size: 10px;
      color: var(--accent);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    /* ========== DEMO INSTRUCTIONS ========== */
    .demo-banner {
      background: linear-gradient(135deg, var(--accent-dim) 0%, rgba(139,92,246,0.15) 100%);
      border-bottom: 1px solid var(--accent-dim);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .demo-banner-text {
      font-size: 13px;
      color: var(--text-primary);
    }

    .demo-banner-text strong {
      color: var(--accent);
    }

    .demo-banner-btn {
      padding: 6px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
    }

    .demo-banner-btn:hover {
      background: var(--accent-hover);
    }

    /* Demo step indicator */
    .demo-step {
      position: fixed;
      top: 120px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 16px;
      width: 280px;
      z-index: 200;
      box-shadow: var(--panel-shadow);
    }

    .demo-step-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .demo-step-num {
      width: 22px;
      height: 22px;
      background: var(--accent);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
    }

    .demo-step-desc {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .demo-step-action {
      margin-top: 12px;
      padding: 8px 14px;
      background: var(--accent-dim);
      border: 1px solid var(--accent);
      border-radius: 6px;
      color: var(--accent);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }

    .demo-step-action:hover {
      background: var(--accent);
      color: white;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- Demo Banner -->
    <div class="demo-banner" id="demo-banner">
      <span class="demo-banner-text">
        <strong>Notification Center Demo:</strong> Click the üîî bell to view notifications, or add new ones ‚Üí
      </span>
      <div style="display: flex; gap: 6px;">
        <button class="demo-banner-btn" style="background: #ef4444;" onclick="addDemoNotification('error')">+ Error</button>
        <button class="demo-banner-btn" style="background: #f59e0b;" onclick="addDemoNotification('warning')">+ Warning</button>
        <button class="demo-banner-btn" style="background: #22c55e;" onclick="addDemoNotification('success')">+ Success</button>
        <button class="demo-banner-btn" style="background: #3b82f6;" onclick="addDemoNotification('info')">+ Info</button>
        <button class="demo-banner-btn" onclick="resetDemo()">Reset</button>
      </div>
    </div>

    <!-- Top Bar -->
    <nav class="topbar">
      <div class="topbar-left">
        <div class="logo" onclick="goToHome()" title="Home">A</div>
        <div class="breadcrumb" id="breadcrumb">
          <!-- Populated by JS -->
        </div>
      </div>
      <div class="topbar-center" id="workspace-tabs">
        <!-- Populated by JS -->
      </div>
      <div class="topbar-right">
        <button class="notification-bell has-unread" id="notification-bell" onclick="toggleNotificationPanel()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
            <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
          </svg>
          <span class="notification-badge" id="notification-badge">3</span>
        </button>
        <button class="btn btn-ghost" onclick="showHelp()">?</button>
      </div>
    </nav>

    <!-- Notification Panel -->
    <div class="notification-panel" id="notification-panel">
      <div class="notification-header">
        <div class="notification-header-left">
          <span class="notification-header-title">üîî Notifications</span>
          <span class="notification-header-count" id="notification-count">(3 unread)</span>
        </div>
        <div class="notification-header-actions">
          <button class="notification-header-btn" onclick="markAllRead()">Mark all read</button>
          <button class="notification-header-btn" onclick="clearAllNotifications()">Clear</button>
        </div>
      </div>
      <div class="notification-filters">
        <button class="notification-filter active" data-filter="all" onclick="setNotificationFilter('all')">All</button>
        <button class="notification-filter" data-filter="error" onclick="setNotificationFilter('error')">Errors</button>
        <button class="notification-filter" data-filter="warning" onclick="setNotificationFilter('warning')">Warnings</button>
        <button class="notification-filter" data-filter="success" onclick="setNotificationFilter('success')">Success</button>
      </div>
      <div class="notification-list" id="notification-list">
        <!-- Populated by JS -->
      </div>
    </div>

    <div class="main-content">
      <!-- Entry Sidebar (Knowledge Base hierarchy) -->
      <aside class="entry-sidebar" id="entry-sidebar">
        <h3>Knowledge Base</h3>
        <div class="entry-group">
          <div class="entry-root">üìö Root /knowledge-base</div>
          <div class="entry-node active">
            <div>
              Personal
              <div style="font-size:11px;color:var(--text-muted);">Dash ¬∑ Journal ¬∑ Finance</div>
            </div>
            <span>4 workspaces</span>
          </div>
          <div class="entry-node">
            <div>
              Work
              <div style="font-size:11px;color:var(--text-muted);">Clients ¬∑ Reports ¬∑ Labs</div>
            </div>
            <span>5</span>
          </div>
          <div class="entry-node">
            <div>
              Business
              <div style="font-size:11px;color:var(--text-muted);">Leads ¬∑ Ops ¬∑ Finance</div>
            </div>
            <span>3</span>
          </div>
          <div class="entry-node">
            <div>
              Projects
              <div style="font-size:11px;color:var(--text-muted);">Alpha ¬∑ Beta ¬∑ Test4</div>
            </div>
            <span>6</span>
          </div>
        </div>
        <div class="entry-group">
          <div class="entry-root">üóÇ Custom Entries</div>
          <div class="entry-node">
            <div>
              Research
              <div style="font-size:11px;color:var(--text-muted);">Dashboard + Planning + Experiments</div>
            </div>
            <span>3</span>
          </div>
          <div class="entry-node">
            <div>
              Templates
              <div style="font-size:11px;color:var(--text-muted);">Blank dashboards for new teams</div>
            </div>
            <span>2</span>
          </div>
        </div>
      </aside>

      <!-- Canvas -->
      <div class="canvas-container" id="canvas-container">
        <div class="canvas-surface" id="canvas-surface">
          <!-- Panels rendered by JS -->
        </div>
      </div>
    </div>

    <!-- Floating Toolbar -->
    <div class="floating-toolbar">
      <button class="toolbar-btn" title="Select (V)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/>
        </svg>
      </button>
      <button class="toolbar-btn" title="Pan (Space)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 9l-3 3 3 3M9 5l3-3 3 3M15 19l-3 3-3-3M19 9l3 3-3 3M2 12h20M12 2v20"/>
        </svg>
      </button>
      <div class="toolbar-divider"></div>
      <button class="toolbar-btn" id="add-panel-btn" title="Add Panel (+)">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2"/>
          <path d="M12 8v8M8 12h8"/>
        </svg>
      </button>
    </div>

    <!-- Keyboard Hints -->
    <div class="keyboard-hints">
      <div class="hint"><span class="hint-key">H</span> Home</div>
      <div class="hint"><span class="hint-key">Cmd+K</span> Link</div>
    </div>

    <!-- Minimap -->
    <div class="minimap" id="minimap"></div>

    <!-- Demo Step Indicator -->
    <div class="demo-step" id="demo-step">
      <!-- Populated by JS -->
    </div>
  </div>

  <!-- Link Toolbar (appears on text selection) -->
  <div class="link-toolbar" id="link-toolbar">
    <button class="link-toolbar-btn" onclick="showWorkspacePicker()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
      Link to Workspace
    </button>
  </div>

  <!-- Workspace Picker with Entry Filter -->
  <div class="workspace-picker" id="workspace-picker">
    <div class="picker-header">
      <svg class="picker-header-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
      <span class="picker-header-title">Link to Workspace</span>
      <button class="picker-header-close" onclick="hidePicker()">x</button>
    </div>
    <div class="picker-selected-text" id="picker-selected-text">
      Link text: <span>"test4"</span>
    </div>
    <div class="picker-search">
      <input type="text" placeholder="Search workspaces..." id="picker-search-input" oninput="filterPicker(this.value)">
    </div>
    <div class="picker-filter">
      <button class="filter-btn active" id="filter-current" onclick="setFilter('current')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        </svg>
        Home
      </button>
      <button class="filter-btn" id="filter-all" onclick="setFilter('all')">
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
        </svg>
        All Entries
      </button>
    </div>
    <div class="picker-list" id="picker-list">
      <!-- Populated by JS -->
    </div>
    <div class="picker-create" id="picker-create" onclick="createNewEntryWorkspace()">
      <div class="picker-create-icon">+</div>
      <div>
        <div class="picker-create-text">+ Create "test4" workspace</div>
        <div class="picker-create-desc">Creates new entry with Dashboard</div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <script>
    // ========== DATA ==========
    const entries = [
      {
        id: "home",
        name: "Home",
        icon: "H",
        summary: "System entry",
        group: "system",
        workspaces: [
          { id: "home-dashboard", name: "Dashboard", isDefault: true }
        ]
      },
      {
        id: "personal",
        name: "Personal",
        icon: "P",
        summary: "Dash ¬∑ Journal ¬∑ Finance",
        group: "knowledge-base",
        workspaces: [
          { id: "personal-dashboard", name: "Dashboard", isDefault: true },
          { id: "personal-daily", name: "Daily Notes" },
          { id: "personal-journal", name: "Journal" },
          { id: "personal-finance", name: "Finance" }
        ]
      },
      {
        id: "work",
        name: "Work",
        icon: "W",
        summary: "Clients ¬∑ Reports ¬∑ Labs",
        group: "knowledge-base",
        workspaces: [
          { id: "work-dashboard", name: "Dashboard", isDefault: true },
          { id: "work-clients", name: "Client Board" },
          { id: "work-reports", name: "Reports" },
          { id: "work-labs", name: "Labs" }
        ]
      },
      {
        id: "business",
        name: "Business",
        icon: "B",
        summary: "Leads ¬∑ Ops ¬∑ Finance",
        group: "knowledge-base",
        workspaces: [
          { id: "business-dashboard", name: "Dashboard", isDefault: true },
          { id: "business-leads", name: "Leads" },
          { id: "business-ops", name: "Operations" }
        ]
      },
      {
        id: "projects",
        name: "Projects",
        icon: "PR",
        summary: "Alpha ¬∑ Beta ¬∑ Test4",
        group: "knowledge-base",
        workspaces: [
          { id: "projects-dashboard", name: "Dashboard", isDefault: true },
          { id: "projects-alpha", name: "Project Alpha" },
          { id: "projects-beta", name: "Project Beta" },
          { id: "projects-test4", name: "Test4" }
        ]
      },
      {
        id: "research",
        name: "Research",
        icon: "R",
        summary: "Brainstorms ¬∑ Experiments",
        group: "custom",
        workspaces: [
          { id: "research-dashboard", name: "Dashboard", isDefault: true },
          { id: "research-notes", name: "Notes" }
        ]
      },
      {
        id: "templates",
        name: "Templates",
        icon: "T",
        summary: "Starter boards",
        group: "custom",
        workspaces: [
          { id: "templates-dashboard", name: "Dashboard", isDefault: true },
          { id: "templates-engineering", name: "Engineering" }
        ]
      }
    ];

    const entryGroups = [
      { id: "knowledge-base", title: "Knowledge Base", rootLabel: "/knowledge-base", entryIds: ["personal","work","business","projects"] },
      { id: "custom", title: "Custom Entries", rootLabel: "", entryIds: ["research","templates"] }
    ];

    // Panel types
    const panelTypes = [
      { id: "note", name: "Note", icon: "üìù", desc: "Text note with links" },
      { id: "continue", name: "Continue", icon: "‚ñ∂", desc: "Resume last workspace" },
      { id: "navigator", name: "Navigator", icon: "üìÅ", desc: "Browse entries" },
      { id: "recent", name: "Recent", icon: "üïê", desc: "Recent workspaces" },
      { id: "capture", name: "Quick Capture", icon: "‚úèÔ∏è", desc: "Capture ideas" },
      { id: "links", name: "Quick Links", icon: "üîó", desc: "Quick link notes" }
    ];

    // Default Dashboard panels (what appears when navigating to an entry's Dashboard)
    const defaultDashboardPanels = [
      { id: "p1", type: "continue", x: 40, y: 40, width: 320, title: "Continue" },
      { id: "p2", type: "navigator", x: 40, y: 200, width: 280, title: "Navigator" },
      { id: "p3", type: "recent", x: 380, y: 40, width: 280, title: "Recent" },
      { id: "p4", type: "capture", x: 380, y: 280, width: 280, title: "Quick Capture" },
      { id: "p5", type: "links", x: 700, y: 40, width: 320, title: "Quick Links" }
    ];

    // Workspace panel configurations
    const workspacePanels = {
      "home-dashboard": [
        { id: "p1", type: "continue", x: 40, y: 40, width: 320, title: "Continue" },
        { id: "p2", type: "navigator", x: 40, y: 200, width: 280, title: "Navigator" },
        { id: "p3", type: "recent", x: 380, y: 40, width: 280, title: "Recent" },
        { id: "p4", type: "capture", x: 380, y: 280, width: 280, title: "Quick Capture" },
        { id: "p5", type: "links", x: 700, y: 40, width: 320, title: "Quick Links",
          content: `<h3>Projects</h3>
            <p><span class="workspace-link" data-entry="projects" data-workspace="projects-alpha">Project Alpha</span></p>
            <p><span class="workspace-link" data-entry="projects" data-workspace="projects-beta">Project Beta</span></p>
            <h3>Create New</h3>
            <p><span class="workspace-link demo-create" data-name="test4">test4</span> - click to demo!</p>`
        }
      ],
      "personal-dashboard": mapPanels("personal"),
      "work-dashboard": mapPanels("work"),
      "business-dashboard": mapPanels("business"),
      "projects-dashboard": mapPanels("projects"),
      "research-dashboard": mapPanels("research"),
      "templates-dashboard": mapPanels("templates")
    };

    function mapPanels(entryId) {
      const entry = entries.find(e => e.id === entryId);
      const entryLabel = entry ? entry.name : entryId;
      return defaultDashboardPanels.map(p => ({
        ...p,
        id: `${entryId}-${p.id}`,
        content: p.type === 'links'
          ? `<h3>${entryLabel} Links</h3>
              <p><span class="workspace-link" data-entry="home" data-workspace="home-dashboard">Back to Home</span></p>
              <p>Add more links here...</p>`
          : undefined
      }));
    }

    // ========== STATE ==========
    let currentEntry = entries[0];
    let currentWorkspace = entries[0].workspaces[0];
    let lastNonHomeWorkspace = { entry: entries[1], workspace: entries[1].workspaces[1] };
    let panels = [];
    let draggingPanel = null;
    let dragOffset = { x: 0, y: 0 };
    let selectedText = "test4";
    let demoStep = 1;
    let filterMode = 'current';

    // ========== NAVIGATION ==========
    function goToHome() {
      navigateTo("home", "home-dashboard");
      demoStep = 1;
      updateDemoStep();
    }

    function navigateTo(entryId, workspaceId) {
      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;

      const workspace = entry.workspaces.find(w => w.id === workspaceId);
      if (!workspace) return;

      // Track last non-home workspace
      if (entryId !== "home") {
        lastNonHomeWorkspace = { entry, workspace };
      }

      currentEntry = entry;
      currentWorkspace = workspace;

      render();
      showToast(`${entry.name} / ${workspace.name}`);
    }

    function switchWorkspace(workspaceId) {
      const workspace = currentEntry.workspaces.find(w => w.id === workspaceId);
      if (workspace) {
        if (currentEntry.id !== "home") {
          lastNonHomeWorkspace = { entry: currentEntry, workspace };
        }
        currentWorkspace = workspace;
        render();
      }
    }

    // ========== CREATE NEW ENTRY + WORKSPACE (Expected Flow) ==========
    function createNewEntryWorkspace() {
      hidePicker();

      // Simulate creating new entry "test4"
    const newEntry = {
      id: "test4",
      name: "test4",
      icon: "T",
      summary: "New entry",
      group: "knowledge-base",
      workspaces: [
        { id: "test4-dashboard", name: "Dashboard", isDefault: true },
        { id: "test4-default", name: "test4" }
      ]
    };

    // Add to entries list
    if (!entries.find(e => e.id === "test4")) {
      entries.push(newEntry);
      const kbGroup = entryGroups.find(g => g.id === 'knowledge-base');
      if (kbGroup && !kbGroup.entryIds.includes(newEntry.id)) {
        kbGroup.entryIds.push(newEntry.id);
      }
    }

      // Create Dashboard panels for new entry
      workspacePanels["test4-dashboard"] = [...defaultDashboardPanels].map((p, i) => ({
        ...p,
        id: `test4-${p.id}`,
        content: p.type === 'links' ? `<h3>test4 Links</h3>
          <p><span class="workspace-link" data-entry="home" data-workspace="home-dashboard">Back to Home</span></p>
          <p>Add more links here...</p>` : undefined
      }));

      // Update demo step
      demoStep = 3;
      updateDemoStep();

      // Show success toast
      showToast('Created entry "test4" with Dashboard!', 'success');

      // Navigate to the NEW entry's Dashboard (this is the expected behavior!)
      setTimeout(() => {
        navigateTo("test4", "test4-dashboard");
      }, 500);
    }

    // ========== RENDER ==========
function render() {
  renderBreadcrumb();
  renderTabs();
  renderPanels();
  renderSidebar();
  renderMinimap();
}

function renderSidebar() {
  const sidebar = document.getElementById("entry-sidebar");
  if (!sidebar) return;

  let html = "";
  entryGroups.forEach(group => {
    html += `<div class="entry-group">`;
    html += `<div class="entry-root">${group.id === 'knowledge-base' ? 'üìö' : group.id === 'system' ? '‚öôÔ∏è' : 'üóÇ'} ${group.title}${group.rootLabel ? `<span style="font-size:11px;color:var(--text-muted);margin-left:6px;">${group.rootLabel}</span>` : ''}</div>`;
    group.entryIds.forEach(entryId => {
      const entry = entries.find(e => e.id === entryId);
      if (!entry) return;
      const isActive = entry.id === currentEntry.id;
      html += `
        <div class="entry-node ${isActive ? 'active' : ''}" data-entry="${entry.id}">
          <div>
            ${entry.name}
            <div class="entry-summary">${entry.summary || ''}</div>
          </div>
          <span>${entry.workspaces.length} workspaces</span>
        </div>
      `;
    });
    html += `</div>`;
  });

  sidebar.innerHTML = html;
  sidebar.querySelectorAll('.entry-node').forEach(node => {
    node.addEventListener('click', () => {
      const entryId = node.getAttribute('data-entry');
      const entry = entries.find(e => e.id === entryId);
      if (entry) {
        const defaultWorkspace = entry.workspaces[0];
        navigateTo(entry.id, defaultWorkspace.id);
      }
    });
  });
}

function renderBreadcrumb() {
  const bc = document.getElementById("breadcrumb");

  if (currentEntry.group === 'system') {
    bc.innerHTML = `
      <span class="breadcrumb-item current">${currentEntry.name}</span>
      <span class="home-badge">System</span>
    `;
  } else {
    const group = entryGroups.find(g => g.entryIds.includes(currentEntry.id));
    const rootLabel = group?.title || 'Knowledge Base';
    bc.innerHTML = `
      <span class="breadcrumb-item" onclick="goToHome()">${rootLabel}</span>
      <span class="breadcrumb-separator">/</span>
      <span class="breadcrumb-item current">${currentEntry.name}</span>
      <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item current">${currentWorkspace.name}</span>
        `;
      }
    }

    function renderTabs() {
      const tabs = document.getElementById("workspace-tabs");
      tabs.innerHTML = currentEntry.workspaces.map(ws => `
        <button class="workspace-tab ${ws.id === currentWorkspace.id ? 'active' : ''}"
                onclick="switchWorkspace('${ws.id}')">${ws.name}</button>
      `).join('');
    }

    function renderPanels() {
      const surface = document.getElementById("canvas-surface");
      panels = workspacePanels[currentWorkspace.id] || [];

      surface.innerHTML = panels.map((panel, idx) => {
        const type = panelTypes.find(t => t.id === panel.type);
        return `
          <div class="panel ${panel.type === 'continue' ? 'panel-continue' : ''}"
               id="panel-${panel.id}"
               data-index="${idx}"
               style="left:${panel.x}px;top:${panel.y}px;width:${panel.width}px">
            <div class="panel-header" onmousedown="startDrag(event, ${idx})">
              <span class="panel-title">
                <span class="panel-title-icon">${type?.icon || 'üì¶'}</span>
                ${panel.title || type?.name || 'Panel'}
              </span>
              <div class="panel-actions">
                <button class="panel-action" onclick="removePanel(${idx})" title="Remove">x</button>
              </div>
            </div>
            <div class="panel-content">${renderPanelContent(panel)}</div>
          </div>
        `;
      }).join('');

      // Add click handlers for workspace links
      document.querySelectorAll('.workspace-link').forEach(link => {
        if (link.classList.contains('demo-create')) {
          link.onclick = (e) => {
            e.preventDefault();
            demoStep = 2;
            updateDemoStep();
            showWorkspacePicker();
          };
        } else {
          link.onclick = () => {
            const targetEntry = link.dataset.entry;
            const targetWorkspace = link.dataset.workspace;
            if (targetEntry && targetWorkspace) {
              navigateTo(targetEntry, targetWorkspace);
            }
          };
        }
      });
    }

    function renderPanelContent(panel) {
      switch (panel.type) {
        case 'continue':
          return `
            <div class="continue-card" onclick="navigateTo('${lastNonHomeWorkspace.entry.id}', '${lastNonHomeWorkspace.workspace.id}')">
              <div class="continue-icon">‚ñ∂</div>
              <div class="continue-info">
                <div class="continue-label">Continue where you left off</div>
                <div class="continue-title">${lastNonHomeWorkspace.entry.name} / ${lastNonHomeWorkspace.workspace.name}</div>
                <div class="continue-meta">Last edited 5 minutes ago</div>
              </div>
            </div>
          `;

        case 'navigator':
          return entries.filter(e => !e.isSystem).map(entry => `
            <div class="entry-item expanded ${currentEntry.id === entry.id ? 'active' : ''}">
              <div class="entry-header" onclick="this.parentElement.classList.toggle('expanded')">
                <span class="entry-toggle">‚ñ∏</span>
                <span class="entry-icon">${entry.icon}</span>
                <span class="entry-name">${entry.name}</span>
              </div>
              <div class="entry-children">
                ${entry.workspaces.map(ws => `
                  <div class="workspace-item ${currentEntry.id === entry.id && currentWorkspace.id === ws.id ? 'current' : ''}"
                       onclick="navigateTo('${entry.id}', '${ws.id}')">
                    <span class="workspace-dot"></span>
                    ${ws.name}${ws.isDefault ? ' (default)' : ''}
                  </div>
                `).join('')}
              </div>
            </div>
          `).join('');

        case 'recent':
          const recentItems = [
            { entry: entries[1], workspace: entries[1].workspaces[2], time: '5m' },
            { entry: entries[2], workspace: entries[2].workspaces[1], time: '1h' }
          ];
          return recentItems.map(item => `
            <div class="recent-item" onclick="navigateTo('${item.entry.id}', '${item.workspace.id}')">
              <div class="recent-item-left">
                <div class="recent-item-icon">${item.entry.icon}</div>
                <div>
                  <div class="recent-item-name">${item.workspace.name}</div>
                  <div class="recent-item-entry">${item.entry.name}</div>
                </div>
              </div>
              <span class="recent-item-time">${item.time}</span>
            </div>
          `).join('');

        case 'capture':
          return `
            <textarea class="capture-input" placeholder="Capture a quick thought..."></textarea>
            <div class="capture-footer">
              <span class="capture-dest">‚Üí ${currentEntry.name}</span>
              <button class="capture-btn">Send</button>
            </div>
          `;

        case 'links':
          return `<div class="note-content" contenteditable="true">${panel.content || '<p>Add quick links here...</p>'}</div>`;

        case 'note':
          return `<div class="note-content" contenteditable="true">${panel.content || '<p>Start typing...</p>'}</div>`;

        default:
          return '<p>Panel content</p>';
      }
    }

    function renderMinimap() {
      const minimap = document.getElementById('minimap');
      const container = document.getElementById('canvas-container');
      const scale = 150 / 3000;

      const vw = (container.clientWidth / 3000) * 150;
      const vh = (container.clientHeight / 2000) * 100;

      let html = '';
      panels.forEach(panel => {
        const x = panel.x * scale;
        const y = panel.y * (100/2000);
        const w = panel.width * scale;
        const h = 15 * scale;
        html += `<div class="minimap-panel" style="left:${x}px;top:${y}px;width:${w}px;height:${h}px"></div>`;
      });

      html += `<div class="minimap-viewport" style="width:${vw}px;height:${vh}px;left:${(container.scrollLeft / 3000) * 150}px;top:${(container.scrollTop / 2000) * 100}px"></div>`;
      minimap.innerHTML = html;
    }

    // ========== DEMO STEP UPDATES ==========
    function updateDemoStep() {
      const stepEl = document.getElementById('demo-step');
      const steps = {
        1: {
          title: "Click a Quick Link",
          desc: "In the Quick Links panel, click on <strong>'test4'</strong> to see the workspace picker and create a new entry.",
          action: null
        },
        2: {
          title: "Create New Entry",
          desc: "Click <strong>'+ Create test4 workspace'</strong> to create a new entry with its own Dashboard and workspaces.",
          action: null
        },
        3: {
          title: "New Entry Created!",
          desc: "Notice: You're now on the <strong>Dashboard</strong> of the new 'test4' entry. The Navigator shows 'test4' as active with purple highlighting.",
          action: "Go back to Home"
        }
      };

      const step = steps[demoStep];
      stepEl.innerHTML = `
        <div class="demo-step-title">
          <span class="demo-step-num">${demoStep}</span>
          ${step.title}
        </div>
        <div class="demo-step-desc">${step.desc}</div>
        ${step.action ? `<button class="demo-step-action" onclick="goToHome()">${step.action}</button>` : ''}
      `;
    }

    // ========== WORKSPACE PICKER ==========
    function showWorkspacePicker() {
      const picker = document.getElementById('workspace-picker');
      picker.style.left = '400px';
      picker.style.top = '200px';
      picker.classList.add('visible');

      document.getElementById('picker-selected-text').innerHTML = `Link text: <span>"${selectedText}"</span>`;
      document.getElementById('picker-create').querySelector('.picker-create-text').textContent = `+ Create "${selectedText}" workspace`;

      renderPickerList('');
      document.getElementById('picker-search-input').focus();
    }

    function hidePicker() {
      document.getElementById('workspace-picker').classList.remove('visible');
      document.getElementById('link-toolbar').classList.remove('visible');
    }

    function setFilter(mode) {
      filterMode = mode;
      document.getElementById('filter-current').classList.toggle('active', mode === 'current');
      document.getElementById('filter-all').classList.toggle('active', mode === 'all');

      // Update filter button text based on current entry
      document.getElementById('filter-current').innerHTML = `
        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
        </svg>
        ${currentEntry.name}
      `;

      renderPickerList(document.getElementById('picker-search-input').value);
    }

    function renderPickerList(filter) {
      const list = document.getElementById('picker-list');
      const lowerFilter = filter.toLowerCase();

      let html = '';
      const entriesToShow = filterMode === 'current' ? [currentEntry] : entries.filter(e => !e.isSystem);

      entriesToShow.forEach(entry => {
        const matchingWorkspaces = entry.workspaces.filter(ws =>
          !filter || ws.name.toLowerCase().includes(lowerFilter) || entry.name.toLowerCase().includes(lowerFilter)
        );

        if (matchingWorkspaces.length > 0) {
          html += `<div class="picker-section-label">${entry.name}</div>`;
          matchingWorkspaces.forEach(ws => {
            html += `
              <div class="picker-item" onclick="selectWorkspace('${entry.id}', '${ws.id}', '${ws.name}')">
                <div class="picker-item-icon">${entry.icon}</div>
                <div class="picker-item-info">
                  <div class="picker-item-name">${ws.name}</div>
                  <div class="picker-item-path">${entry.name} > ${ws.name}</div>
                </div>
              </div>
            `;
          });
        }
      });

      if (!html) {
        html = '<div style="padding: 20px; text-align: center; color: var(--text-muted);">No matching workspaces</div>';
      }

      list.innerHTML = html;
    }

    function filterPicker(value) {
      selectedText = value || "test4";
      document.getElementById('picker-create').querySelector('.picker-create-text').textContent = `+ Create "${selectedText}" workspace`;
      renderPickerList(value);
    }

    function selectWorkspace(entryId, workspaceId, wsName) {
      hidePicker();
      showToast(`Linked to ${wsName}`);
      navigateTo(entryId, workspaceId);
    }

    // ========== DRAG & DROP ==========
    function startDrag(e, index) {
      if (e.target.closest('.panel-actions')) return;

      draggingPanel = document.querySelector(`[data-index="${index}"]`);
      draggingPanel.classList.add('dragging');

      const rect = draggingPanel.getBoundingClientRect();
      dragOffset = {
        x: e.clientX - rect.left,
        y: e.clientY - rect.top
      };

      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
    }

    function onDrag(e) {
      if (!draggingPanel) return;

      const container = document.getElementById('canvas-container');
      const containerRect = container.getBoundingClientRect();

      let x = e.clientX - containerRect.left + container.scrollLeft - dragOffset.x;
      let y = e.clientY - containerRect.top + container.scrollTop - dragOffset.y;

      x = Math.max(0, x);
      y = Math.max(0, y);

      draggingPanel.style.left = x + 'px';
      draggingPanel.style.top = y + 'px';

      const index = parseInt(draggingPanel.dataset.index);
      if (workspacePanels[currentWorkspace.id] && workspacePanels[currentWorkspace.id][index]) {
        workspacePanels[currentWorkspace.id][index].x = x;
        workspacePanels[currentWorkspace.id][index].y = y;
      }

      renderMinimap();
    }

    function stopDrag() {
      if (draggingPanel) {
        draggingPanel.classList.remove('dragging');
        draggingPanel = null;
      }
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
    }

    function removePanel(index) {
      workspacePanels[currentWorkspace.id].splice(index, 1);
      render();
    }

    // ========== UTILITIES ==========
    function showToast(message, type = '') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast visible' + (type ? ' ' + type : '');
      setTimeout(() => toast.classList.remove('visible'), 2500);
    }

    function showHelp() {
      alert(`Entry-Workspace Hierarchy Demo

EXPECTED FLOW:
1. Click a Quick Link (e.g., "test4")
2. Workspace picker appears with:
   - Entry filter toggle (Current Entry / All)
   - "+ Create 'test4' workspace" option
3. Clicking create:
   - Creates NEW entry "test4" in /knowledge-base/test4
   - Creates Dashboard workspace (default, with 5 panels)
   - Creates "test4" workspace (for notes)
4. Navigates to the NEW entry's Dashboard
5. Navigator shows "test4" as ACTIVE (purple highlight)

KEY UI ELEMENTS:
- Workspace tabs show: Dashboard | test4
- Breadcrumb shows: Home / test4 / Dashboard
- Navigator highlights active entry
- Dashboard has 5 panels: Continue, Navigator, Recent, Quick Capture, Quick Links`);
    }

    function resetDemo() {
      // Remove test4 if it exists
      const test4Index = entries.findIndex(e => e.id === "test4");
      if (test4Index > -1) {
        entries.splice(test4Index, 1);
        delete workspacePanels["test4-dashboard"];
      }

      demoStep = 1;
      goToHome();
      updateDemoStep();
      showToast('Demo reset!');
    }

    // ========== KEYBOARD ==========
    document.addEventListener('keydown', (e) => {
      if (e.key === 'h' || e.key === 'H') {
        if (!e.target.closest('[contenteditable]') && !e.target.closest('input')) {
          goToHome();
        }
      }
      if (e.key === 'Escape') {
        hidePicker();
      }
      if (e.key === 'k' && (e.metaKey || e.ctrlKey)) {
        e.preventDefault();
        showWorkspacePicker();
      }
    });

    // Close picker when clicking outside
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.workspace-picker') && !e.target.closest('.link-toolbar') && !e.target.closest('.demo-create')) {
        hidePicker();
      }
    });

    // Update minimap on scroll
    document.getElementById('canvas-container').addEventListener('scroll', renderMinimap);

    // ========== NOTIFICATION CENTER ==========
    let notifications = [
      {
        id: 'n1',
        type: 'error',
        title: 'Workspace save failed',
        description: 'Unable to save workspace while offline',
        time: '2:34 PM',
        timestamp: Date.now() - 60000,
        read: false,
        details: {
          workspace: 'Project Notes',
          workspaceId: 'ws-abc-123',
          error: 'NETWORK_OFFLINE',
          consecutiveFailures: 3,
          suggestedAction: 'Go online and click Retry'
        }
      },
      {
        id: 'n2',
        type: 'error',
        title: 'Workspace save failed',
        description: 'Unable to save workspace while offline',
        time: '2:33 PM',
        timestamp: Date.now() - 120000,
        read: false,
        details: {
          workspace: 'Project Notes',
          workspaceId: 'ws-abc-123',
          error: 'NETWORK_OFFLINE',
          consecutiveFailures: 2,
          suggestedAction: 'Go online and click Retry'
        }
      },
      {
        id: 'n3',
        type: 'warning',
        title: 'Degraded mode entered',
        description: '3 consecutive save failures detected',
        time: '2:32 PM',
        timestamp: Date.now() - 180000,
        read: false,
        details: {
          consecutiveFailures: 3,
          threshold: 3,
          suggestedAction: 'Go online and click Retry in the banner'
        }
      },
      {
        id: 'n4',
        type: 'success',
        title: 'Workspace synced successfully',
        description: 'All changes saved to server',
        time: '2:15 PM',
        timestamp: Date.now() - 1200000,
        read: true,
        details: {
          workspace: 'Daily Notes',
          workspaceId: 'ws-daily-001',
          panelCount: 4,
          componentCount: 2
        }
      },
      {
        id: 'n5',
        type: 'info',
        title: 'Timer completed',
        description: 'Pomodoro timer finished in Workspace 3',
        time: '2:10 PM',
        timestamp: Date.now() - 1500000,
        read: true,
        details: {
          workspace: 'Workspace 3',
          workspaceId: 'ws-003',
          duration: '25 minutes',
          timerType: 'Pomodoro'
        }
      }
    ];

    let notificationFilter = 'all';
    let expandedNotifications = new Set();

    function toggleNotificationPanel() {
      const panel = document.getElementById('notification-panel');
      panel.classList.toggle('visible');
      if (panel.classList.contains('visible')) {
        renderNotifications();
      }
    }

    function closeNotificationPanel() {
      document.getElementById('notification-panel').classList.remove('visible');
    }

    function setNotificationFilter(filter) {
      notificationFilter = filter;
      document.querySelectorAll('.notification-filter').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.filter === filter);
      });
      renderNotifications();
    }

    function toggleNotificationDetails(notifId) {
      if (expandedNotifications.has(notifId)) {
        expandedNotifications.delete(notifId);
      } else {
        expandedNotifications.add(notifId);
      }
      renderNotifications();
    }

    function markAsRead(notifId) {
      const notif = notifications.find(n => n.id === notifId);
      if (notif) {
        notif.read = true;
        updateNotificationBadge();
        renderNotifications();
      }
    }

    function markAllRead() {
      notifications.forEach(n => n.read = true);
      updateNotificationBadge();
      renderNotifications();
      showToast('All notifications marked as read');
    }

    function dismissNotification(notifId) {
      notifications = notifications.filter(n => n.id !== notifId);
      expandedNotifications.delete(notifId);
      updateNotificationBadge();
      renderNotifications();
    }

    function clearAllNotifications() {
      notifications = [];
      expandedNotifications.clear();
      updateNotificationBadge();
      renderNotifications();
      showToast('All notifications cleared');
    }

    function updateNotificationBadge() {
      const unreadCount = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notification-badge');
      const bell = document.getElementById('notification-bell');
      const countEl = document.getElementById('notification-count');

      if (unreadCount > 0) {
        badge.textContent = unreadCount;
        badge.style.display = 'flex';
        bell.classList.add('has-unread');
        countEl.textContent = `(${unreadCount} unread)`;
      } else {
        badge.style.display = 'none';
        bell.classList.remove('has-unread');
        countEl.textContent = '';
      }
    }

    function getNotificationIcon(type) {
      const icons = {
        error: '‚úï',
        warning: '‚ö†',
        success: '‚úì',
        info: '‚Ñπ'
      };
      return icons[type] || '‚Ñπ';
    }

    function renderNotifications() {
      const list = document.getElementById('notification-list');

      let filtered = notifications;
      if (notificationFilter !== 'all') {
        filtered = notifications.filter(n => n.type === notificationFilter);
      }

      if (filtered.length === 0) {
        list.innerHTML = `
          <div class="notification-empty">
            <div class="notification-empty-icon">üîî</div>
            <div class="notification-empty-text">No notifications</div>
          </div>
        `;
        return;
      }

      list.innerHTML = filtered.map(notif => {
        const isExpanded = expandedNotifications.has(notif.id);
        const details = notif.details || {};

        return `
          <div class="notification-item ${notif.read ? '' : 'unread'}" data-id="${notif.id}">
            <div class="notification-row">
              <div class="notification-icon ${notif.type}">${getNotificationIcon(notif.type)}</div>
              <div class="notification-content">
                <div class="notification-title">
                  ${!notif.read ? '<span class="unread-dot"></span>' : ''}
                  ${notif.title}
                </div>
                <div class="notification-desc">${notif.description}</div>
                <div class="notification-time">${notif.time}</div>
              </div>
              <button class="notification-details-toggle ${isExpanded ? 'expanded' : ''}"
                      onclick="toggleNotificationDetails('${notif.id}')">
                Details ${isExpanded ? '‚ñº' : '‚ñ∂'}
              </button>
            </div>
            <div class="notification-details ${isExpanded ? 'visible' : ''}">
              ${details.workspace ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Workspace:</span>
                  <span class="notification-details-value">${details.workspace}</span>
                </div>
              ` : ''}
              ${details.workspaceId ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Workspace ID:</span>
                  <span class="notification-details-value" style="font-family: monospace; font-size: 11px;">${details.workspaceId}</span>
                </div>
              ` : ''}
              ${details.error ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Error:</span>
                  <span class="notification-details-value" style="color: #ef4444;">${details.error}</span>
                </div>
              ` : ''}
              ${details.consecutiveFailures ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Failures:</span>
                  <span class="notification-details-value">${details.consecutiveFailures}${details.threshold ? ` / ${details.threshold} (threshold)` : ''}</span>
                </div>
              ` : ''}
              ${details.duration ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Duration:</span>
                  <span class="notification-details-value">${details.duration}</span>
                </div>
              ` : ''}
              ${details.timerType ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Timer Type:</span>
                  <span class="notification-details-value">${details.timerType}</span>
                </div>
              ` : ''}
              ${details.panelCount !== undefined ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Panels:</span>
                  <span class="notification-details-value">${details.panelCount}</span>
                </div>
              ` : ''}
              ${details.suggestedAction ? `
                <div class="notification-details-row">
                  <span class="notification-details-label">Suggested Action:</span>
                  <span class="notification-details-value action">${details.suggestedAction}</span>
                </div>
              ` : ''}
              <div class="notification-details-actions">
                ${details.workspaceId ? `
                  <button class="notification-details-btn primary" onclick="goToWorkspaceFromNotif('${details.workspaceId}')">
                    Go to Workspace
                  </button>
                ` : ''}
                <button class="notification-details-btn secondary" onclick="dismissNotification('${notif.id}')">
                  Dismiss
                </button>
                ${!notif.read ? `
                  <button class="notification-details-btn secondary" onclick="markAsRead('${notif.id}')">
                    Mark Read
                  </button>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    function goToWorkspaceFromNotif(workspaceId) {
      closeNotificationPanel();
      showToast(`Navigating to workspace ${workspaceId}...`);
      // In real app, would navigate to the workspace
    }

    // Add a demo notification button function
    function addDemoNotification(type) {
      const types = {
        error: {
          title: 'Workspace save failed',
          description: 'Unable to save workspace while offline',
          details: {
            workspace: 'Demo Workspace',
            workspaceId: 'ws-demo-' + Date.now(),
            error: 'NETWORK_OFFLINE',
            consecutiveFailures: 1,
            suggestedAction: 'Go online and click Retry'
          }
        },
        warning: {
          title: 'High memory usage',
          description: '4 workspace runtimes active (at capacity)',
          details: {
            activeWorkspaces: 4,
            capacity: 4,
            suggestedAction: 'Close unused workspaces to free memory'
          }
        },
        success: {
          title: 'Workspace synced',
          description: 'All changes saved successfully',
          details: {
            workspace: 'Demo Workspace',
            workspaceId: 'ws-demo-' + Date.now(),
            panelCount: 3,
            componentCount: 1
          }
        },
        info: {
          title: 'New workspace created',
          description: 'Workspace "New Project" has been created',
          details: {
            workspace: 'New Project',
            workspaceId: 'ws-new-' + Date.now()
          }
        }
      };

      const template = types[type] || types.info;
      const now = new Date();
      const timeStr = now.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });

      const newNotif = {
        id: 'n-' + Date.now(),
        type: type,
        title: template.title,
        description: template.description,
        time: timeStr,
        timestamp: Date.now(),
        read: false,
        details: template.details
      };

      notifications.unshift(newNotif);
      updateNotificationBadge();

      // Open panel to show new notification
      const panel = document.getElementById('notification-panel');
      if (!panel.classList.contains('visible')) {
        toggleNotificationPanel();
      } else {
        renderNotifications();
      }

      showToast(`New ${type} notification added`, type === 'success' ? 'success' : '');
    }

    // Close notification panel when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('notification-panel');
      const bell = document.getElementById('notification-bell');
      if (panel.classList.contains('visible') &&
          !e.target.closest('.notification-panel') &&
          !e.target.closest('.notification-bell')) {
        closeNotificationPanel();
      }
    });

    // ========== INIT ==========
    render();
    updateDemoStep();
    renderNotifications();
    updateNotificationBadge();
  </script>
</body>
</html>
